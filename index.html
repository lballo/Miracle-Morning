<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#f0ebe3">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Miracle Morning">
<meta name="description" content="Timer de routine matinale ‚Äî Miracle Morning">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<title>My Miracle Morning</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet" onload="document.body.classList.add('fonts-loaded')">

<style>
/* ========================================
   ZEN DESIGN SYSTEM ‚Äî Mountain / Serenity
   ======================================== */
:root {
  --bg: #f0ebe3;
  --bg-card: rgba(255,255,255,0.65);
  --bg-card-solid: #FFFFFF;
  --bg-warm: #f7f4ef;
  --bg-accent: #e8e2d8;
  --bg-mountain: #d5cec4;
  --text: #2c2a26;
  --text-soft: #6b665e;
  --text-muted: #a09a90;
  --text-faint: #c4bfb5;
  --zen: #7a8b7a;
  --zen-light: #95a695;
  --zen-dark: #5f6f5f;
  --zen-bg: rgba(122,139,122,0.08);
  --zen-bg-strong: rgba(122,139,122,0.15);
  --stone: #8a8078;
  --stone-light: #a69e96;
  --danger: #b07070;
  --danger-light: rgba(176,112,112,0.08);
  --border: rgba(0,0,0,0.05);
  --border-strong: rgba(0,0,0,0.09);
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.03);
  --shadow-md: 0 4px 20px rgba(0,0,0,0.04), 0 1px 4px rgba(0,0,0,0.02);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.06);
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  --font-display: Georgia, 'Times New Roman', serif;
  --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.fonts-loaded {
  --font-display: 'Cormorant Garamond', Georgia, serif;
  --font-body: 'Nunito', -apple-system, system-ui, sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.65;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  position: relative;
}

/* Mountain background decoration */
body::before {
  content: '';
  position: fixed; top: 0; left: 0; right: 0;
  height: 45vh;
  background: linear-gradient(175deg, #d3c8bb 0%, #c9bfb2 25%, #e0d8cd 50%, #ece6dc 75%, var(--bg) 100%);
  clip-path: polygon(0 0, 100% 0, 100% 55%, 65% 80%, 45% 60%, 25% 85%, 0 65%);
  z-index: 0;
  opacity: 0.55;
}
body::after {
  content: '';
  position: fixed; top: 0; left: 0; right: 0;
  height: 35vh;
  background: linear-gradient(170deg, #bfb5a8 0%, #c9c0b3 40%, transparent 100%);
  clip-path: polygon(0 0, 100% 0, 100% 40%, 75% 70%, 55% 50%, 35% 75%, 15% 55%, 0 70%);
  z-index: 0;
  opacity: 0.3;
}

.hidden { display: none !important; }

button {
  font-family: var(--font-body);
  cursor: pointer; border: none; background: none;
  font-size: 1rem; transition: var(--transition);
}
button:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

input, select {
  font-family: var(--font-body);
  font-size: 1rem;
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-sm);
  padding: 0.75rem 1rem;
  background: var(--bg-card-solid);
  color: var(--text);
  transition: var(--transition);
  outline: none; width: 100%;
}
input:focus, select:focus {
  border-color: var(--zen);
  box-shadow: 0 0 0 3px rgba(122,139,122,0.12);
}

/* ============ LAYOUT ============ */
.app {
  max-width: 540px; margin: 0 auto;
  min-height: 100dvh; width: 100%;
  position: relative; z-index: 1;
}

.app-header {
  padding: 2.5rem 1.5rem 1.25rem;
  text-align: center;
}
.app-header h1 {
  font-family: var(--font-display);
  font-size: 2rem; font-weight: 300;
  letter-spacing: 0.06em; line-height: 1.2;
  color: var(--text);
}
.app-header h1 span {
  font-weight: 500; font-style: italic;
  color: var(--zen-dark);
}
.app-subtitle {
  font-size: 0.8rem; color: var(--text-muted);
  margin-top: 0.4rem; letter-spacing: 0.15em;
  text-transform: uppercase; font-weight: 400;
}

/* Decorative triangle */
.app-header::after {
  content: '‚ñ≤';
  display: block;
  margin: 0.875rem auto 0;
  font-size: 0.7rem;
  color: var(--text-faint);
  letter-spacing: 0.3em;
}

/* ============ BANNERS ============ */
.offline-banner {
  margin: 0 1.25rem 0.5rem; padding: 0.5rem 0.875rem;
  border-radius: var(--radius-sm); font-size: 0.78rem; font-weight: 500;
  display: flex; align-items: center; gap: 0.5rem;
}
.offline-banner.offline-status {
  background: var(--zen-bg); color: var(--zen-dark);
  border: 1px solid rgba(122,139,122,0.12);
}
.offline-banner.install-prompt {
  background: var(--bg-card-solid); color: var(--text);
  border: 1px solid var(--border); box-shadow: var(--shadow-sm);
  justify-content: space-between; cursor: pointer;
}
.install-btn {
  padding: 0.3rem 0.65rem; border-radius: 8px;
  background: var(--zen); color: white;
  font-size: 0.7rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.06em;
}

/* ============ CARDS ============ */
.card {
  background: var(--bg-card);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.35rem;
  margin-bottom: 0.875rem;
  box-shadow: var(--shadow-md);
}
.card-title {
  font-family: var(--font-display);
  font-size: 1.2rem; font-weight: 400;
  margin-bottom: 0.875rem;
  display: flex; align-items: center; gap: 0.5rem;
  letter-spacing: 0.02em;
}
.card-title .icon { font-size: 1.1rem; }

/* ============ ALARM ============ */
.alarm-row {
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 0.875rem; flex-wrap: wrap;
}
.alarm-time-input {
  font-family: var(--font-display);
  font-size: 2.25rem; font-weight: 300;
  text-align: center; width: 100%; max-width: 200px;
  padding: 0.4rem 0.5rem; letter-spacing: 0.06em;
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-md);
  background: var(--bg-warm);
}
.alarm-toggles {
  display: flex; flex-direction: column; gap: 0.625rem;
  flex: 1; min-width: 150px;
}
.toggle-wrap {
  display: flex; align-items: center; gap: 0.65rem;
  font-size: 0.88rem; color: var(--text-soft); font-weight: 500;
}
.toggle { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-track {
  position: absolute; inset: 0;
  background: var(--bg-accent); border-radius: 13px;
  border: 1px solid var(--border-strong);
  cursor: pointer; transition: var(--transition);
}
.toggle-track::after {
  content: ''; position: absolute;
  top: 2px; left: 2px; width: 20px; height: 20px;
  background: white; border-radius: 50%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: var(--transition);
}
.toggle input:checked + .toggle-track {
  background: var(--zen); border-color: var(--zen-dark);
}
.toggle input:checked + .toggle-track::after {
  transform: translateX(22px);
}
.alarm-note {
  font-size: 0.75rem; color: var(--text-muted);
  line-height: 1.5; padding: 0.5rem 0.7rem;
  background: var(--zen-bg); border-radius: var(--radius-sm);
  border: 1px solid rgba(122,139,122,0.06);
}

/* ============ ROUTINE ============ */
.routine-header {
  display: flex; align-items: center; gap: 0.4rem;
  margin-bottom: 0.875rem; flex-wrap: wrap;
}
.routine-select {
  flex: 1; min-width: 0;
  font-size: 0.92rem; font-weight: 600;
  padding: 0.6rem 2.2rem 0.6rem 0.85rem;
  border-radius: var(--radius-sm);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b665e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 0.75rem center;
  text-overflow: ellipsis; overflow: hidden; white-space: nowrap;
}
.routine-actions { display: flex; gap: 0.2rem; flex-shrink: 0; }
.icon-btn {
  width: 38px; height: 38px;
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-warm); color: var(--text-soft);
  font-size: 0.95rem; border: 1px solid var(--border);
}
.icon-btn:hover {
  background: var(--bg-accent); color: var(--text);
  transform: translateY(-1px);
}
.routine-total {
  font-size: 0.88rem; color: var(--text-soft);
  margin-bottom: 0.875rem; padding: 0.5rem 0.75rem;
  background: var(--zen-bg); border-radius: var(--radius-sm);
  border: 1px solid rgba(122,139,122,0.06);
}
.routine-total strong { color: var(--zen-dark); font-weight: 700; }

/* ============ ACTIVITY LIST ‚Äî Touch drag & drop ============ */
.activity-list { display: flex; flex-direction: column; gap: 0.35rem; }
.activity-item {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.7rem 0.65rem;
  background: var(--bg-warm);
  border-radius: var(--radius-md);
  border: 1.5px solid transparent;
  transition: background 0.2s, border-color 0.2s, box-shadow 0.2s, opacity 0.2s;
  min-height: 56px;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
}
.activity-item:active { background: var(--bg-accent); }
.activity-item.dragging {
  opacity: 0.35;
  border-color: var(--zen);
  background: var(--zen-bg);
}
.activity-item.drag-over {
  border-color: var(--zen);
  box-shadow: 0 0 0 2px rgba(122,139,122,0.12);
}
.activity-item.drag-ghost {
  position: fixed;
  z-index: 9999;
  pointer-events: none;
  box-shadow: var(--shadow-lg);
  background: var(--bg-card-solid);
  border-color: var(--zen);
  opacity: 0.92;
  transform: scale(1.03);
}
.activity-grip {
  cursor: grab; color: var(--text-faint);
  font-size: 1rem; padding: 0.35rem;
  touch-action: none; user-select: none;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
.activity-grip:active { cursor: grabbing; }
.activity-grip svg { width: 18px; height: 18px; fill: currentColor; }
.activity-icon-col {
  font-size: 1.3rem; width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-card-solid);
  border-radius: 10px; flex-shrink: 0;
  box-shadow: var(--shadow-sm);
}
.activity-info { flex: 1; min-width: 0; }
.activity-name {
  font-size: 0.92rem; font-weight: 600;
  color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.activity-duration {
  font-family: var(--font-display);
  font-size: 1rem; color: var(--zen-dark);
  font-weight: 400; letter-spacing: 0.03em;
  white-space: nowrap; flex-shrink: 0;
}
.activity-actions { display: flex; gap: 0.1rem; flex-shrink: 0; }
.activity-actions button {
  width: 30px; height: 30px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem; color: var(--text-muted);
}
.activity-actions button:hover {
  background: var(--bg-card-solid); color: var(--text);
}
.activity-actions .del-btn:hover {
  background: var(--danger-light); color: var(--danger);
}

/* Add form */
.add-activity-form {
  display: flex; gap: 0.35rem; margin-top: 0.875rem;
  align-items: flex-end;
}
.add-activity-form .field { flex: 1; min-width: 0; }
.add-activity-form .field-sm { width: 56px; flex-shrink: 0; }
.field label {
  display: block; font-size: 0.65rem;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-muted); margin-bottom: 0.2rem; font-weight: 600;
}
.field input { font-size: 0.88rem; padding: 0.6rem 0.65rem; }
.btn-add {
  height: 42px; width: 42px; flex-shrink: 0;
  border-radius: var(--radius-sm);
  background: var(--zen); color: white; font-size: 1.3rem;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(122,139,122,0.25);
}
.btn-add:hover {
  background: var(--zen-dark); transform: translateY(-1px);
}

/* ============ START BUTTON ============ */
.start-area {
  position: fixed; bottom: 0;
  left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 540px;
  padding: 1rem 1.25rem;
  padding-bottom: max(1rem, env(safe-area-inset-bottom));
  background: linear-gradient(to top, var(--bg) 60%, transparent);
  z-index: 50;
}
.btn-start {
  width: 100%; padding: 1rem;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, var(--zen-light), var(--zen-dark));
  color: white; font-size: 0.95rem; font-weight: 700;
  letter-spacing: 0.1em; text-transform: uppercase;
  box-shadow: 0 4px 20px rgba(122,139,122,0.3);
  position: relative; overflow: hidden;
}
.btn-start::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.12));
  opacity: 0; transition: var(--transition);
}
.btn-start:hover::before { opacity: 1; }
.btn-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 28px rgba(122,139,122,0.4);
}

/* ============ EXECUTION VIEW ============ */
.execution-view {
  position: fixed; inset: 0; z-index: 100;
  background: var(--bg);
  display: flex; flex-direction: column; overflow: hidden;
}
/* Mountain silhouette in execution */
.execution-view::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 40vh;
  background: linear-gradient(175deg, #d3c8bb 0%, #ddd5c9 40%, var(--bg) 100%);
  clip-path: polygon(0 0, 100% 0, 100% 50%, 70% 75%, 50% 55%, 30% 80%, 0 60%);
  opacity: 0.4; z-index: 0;
}
.execution-view > * { position: relative; z-index: 1; }

.exec-header {
  padding: 1rem 1.25rem 0.5rem;
  display: flex; align-items: center; justify-content: space-between;
}
.exec-close, .exec-mute {
  width: 42px; height: 42px; border-radius: var(--radius-sm);
  background: rgba(255,255,255,0.6); backdrop-filter: blur(8px);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; color: var(--text-soft);
}
.exec-close:hover, .exec-mute:hover { background: var(--bg-accent); }
.exec-mute.muted { color: var(--danger); background: var(--danger-light); }
.exec-routine-name {
  font-family: var(--font-display);
  font-size: 1rem; font-weight: 300;
  color: var(--text-soft); font-style: italic;
  flex: 1; text-align: center; padding: 0 0.5rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  letter-spacing: 0.03em;
}
.exec-progress-bar {
  height: 3px; background: var(--bg-accent);
  margin: 0.25rem 1.25rem 0; border-radius: 2px; overflow: hidden;
}
.exec-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--zen-light), var(--zen-dark));
  border-radius: 2px; transition: width 0.5s linear;
}

.exec-main {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 1rem; text-align: center;
  overflow-y: auto;
}
.exec-activity-icon {
  font-size: 2.75rem; margin-bottom: 0.25rem;
  animation: breathe 4s ease-in-out infinite;
}
@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 0.9; }
  50% { transform: scale(1.08); opacity: 1; }
}
.exec-step-label {
  font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.18em; color: var(--text-muted);
  margin-bottom: 0.2rem; font-weight: 600;
}
.exec-activity-name {
  font-family: var(--font-display);
  font-size: 1.75rem; font-weight: 400; color: var(--text);
  margin-bottom: 1.25rem; line-height: 1.15;
  padding: 0 0.5rem; letter-spacing: 0.01em;
}

.exec-circle-wrap {
  position: relative; width: 200px; height: 200px;
  margin-bottom: 1.25rem;
}
.exec-circle-svg {
  transform: rotate(-90deg); width: 100%; height: 100%;
  filter: drop-shadow(0 2px 8px rgba(122,139,122,0.1));
}
.exec-circle-bg { fill: none; stroke: var(--bg-accent); stroke-width: 4; }
.exec-circle-fg {
  fill: none; stroke: url(#zenGradient); stroke-width: 4;
  stroke-linecap: round; transition: stroke-dashoffset 0.5s linear;
}
.exec-circle-time {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.exec-time-big {
  font-family: var(--font-display);
  font-size: 3.25rem; font-weight: 300;
  letter-spacing: 0.03em; color: var(--text); line-height: 1;
}
.exec-time-label {
  font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.15em; color: var(--text-muted);
  margin-top: 0.25rem; font-weight: 500;
}
.exec-next {
  font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.2rem;
}
.exec-next strong { color: var(--text-soft); font-weight: 600; }
.exec-total-remaining {
  font-size: 0.78rem; color: var(--text-faint);
}

.exec-controls {
  padding: 0.75rem 1.25rem;
  padding-bottom: max(1rem, env(safe-area-inset-bottom));
  display: flex; flex-direction: column; gap: 0.5rem;
}
.exec-controls-main {
  display: flex; align-items: center; justify-content: center; gap: 0.75rem;
}
.ctrl-btn {
  width: 48px; height: 48px; border-radius: var(--radius-md);
  background: rgba(255,255,255,0.65); backdrop-filter: blur(8px);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.15rem; color: var(--text-soft); box-shadow: var(--shadow-sm);
}
.ctrl-btn:hover {
  background: var(--bg-accent); color: var(--text);
  transform: translateY(-1px);
}
.ctrl-btn-primary {
  width: 62px; height: 62px;
  background: linear-gradient(135deg, var(--zen-light), var(--zen-dark));
  color: white; font-size: 1.4rem; border: none;
  box-shadow: 0 4px 16px rgba(122,139,122,0.3);
  border-radius: var(--radius-lg);
}
.ctrl-btn-primary:hover { transform: scale(1.05) translateY(-1px); }
.exec-controls-secondary {
  display: flex; justify-content: center; gap: 0.35rem; flex-wrap: wrap;
}
.ctrl-btn-sm {
  padding: 0.4rem 0.75rem; border-radius: var(--radius-sm);
  font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
  background: rgba(255,255,255,0.5); border: 1px solid var(--border);
  text-transform: uppercase; letter-spacing: 0.06em;
}
.ctrl-btn-sm:hover { color: var(--text); background: var(--bg-accent); }
.ctrl-btn-sm.active {
  color: var(--zen-dark); background: var(--zen-bg-strong);
  border-color: var(--zen-light);
}

/* ============ ALARM OVERLAY ============ */
.alarm-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: linear-gradient(160deg, #2c2a26, #3a3630 30%, #2c2a26);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; color: white;
  animation: fadeIn 0.5s ease; padding: 2rem;
}
/* Subtle mountain in alarm */
.alarm-overlay::before {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 40%;
  background: linear-gradient(to top, rgba(122,139,122,0.08), transparent);
  clip-path: polygon(0 60%, 20% 30%, 40% 55%, 60% 20%, 80% 50%, 100% 35%, 100% 100%, 0 100%);
}

@keyframes fadeIn {
  from { opacity: 0; } to { opacity: 1; }
}
.alarm-overlay .alarm-icon {
  font-size: 3.5rem;
  animation: gentleFloat 3s ease-in-out infinite;
  margin-bottom: 1.5rem; position: relative;
}
@keyframes gentleFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
.alarm-overlay .alarm-time-display {
  font-family: var(--font-display);
  font-size: 4rem; font-weight: 300; letter-spacing: 0.06em;
  margin-bottom: 0.5rem; color: var(--zen-light);
  text-shadow: 0 2px 20px rgba(122,139,122,0.3);
  position: relative;
}
.alarm-overlay .alarm-label {
  font-size: 0.85rem; color: rgba(255,255,255,0.3);
  text-transform: uppercase; letter-spacing: 0.25em;
  margin-bottom: 3rem; font-weight: 400; position: relative;
}
.btn-stop-alarm {
  padding: 1rem 2.5rem; border-radius: 60px;
  background: var(--zen); color: white;
  font-size: 1rem; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase;
  box-shadow: 0 4px 24px rgba(122,139,122,0.35);
  animation: glowPulse 3s ease-in-out infinite;
  position: relative;
}
@keyframes glowPulse {
  0%,100% { box-shadow: 0 4px 24px rgba(122,139,122,0.35); }
  50% { box-shadow: 0 4px 40px rgba(122,139,122,0.55); }
}

/* ============ MODAL ============ */
.modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(44,42,38,0.4);
  backdrop-filter: blur(4px); z-index: 300;
  display: flex; align-items: flex-end; justify-content: center;
  animation: fadeIn 0.2s ease;
}
.modal {
  background: var(--bg-card-solid);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  padding: 1.5rem 1.25rem;
  padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
  width: 100%; max-width: 540px; max-height: 80dvh;
  overflow-y: auto;
  animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes slideUp {
  from { transform: translateY(100%); } to { transform: translateY(0); }
}
.modal-handle {
  width: 36px; height: 3px; background: var(--bg-accent);
  border-radius: 2px; margin: 0 auto 1rem;
}
.modal-title {
  font-family: var(--font-display);
  font-size: 1.3rem; font-weight: 400; margin-bottom: 1rem;
}
.modal-field { margin-bottom: 0.875rem; }
.modal-field label {
  display: block; font-size: 0.7rem;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-muted); margin-bottom: 0.3rem; font-weight: 600;
}
.modal-actions { display: flex; gap: 0.5rem; margin-top: 1.25rem; }
.modal-actions button {
  flex: 1; padding: 0.8rem; border-radius: var(--radius-md);
  font-weight: 600; font-size: 0.95rem;
}
.btn-modal-cancel {
  background: var(--bg-warm); color: var(--text-soft);
  border: 1px solid var(--border-strong);
}
.btn-modal-confirm {
  background: var(--zen); color: white;
  box-shadow: 0 2px 8px rgba(122,139,122,0.2);
}
.btn-modal-confirm:hover { background: var(--zen-dark); }

/* FINISHED */
.exec-finished {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; padding: 2rem;
}
.exec-finished .done-icon { font-size: 4rem; margin-bottom: 1rem; }
.exec-finished h2 {
  font-family: var(--font-display);
  font-size: 2rem; font-weight: 300; margin-bottom: 0.5rem;
  letter-spacing: 0.02em;
}
.exec-finished p {
  color: var(--text-soft); font-size: 1rem;
  margin-bottom: 2rem;
}
.btn-back-config {
  padding: 0.875rem 2.5rem; border-radius: var(--radius-lg);
  background: var(--zen); color: white; font-weight: 700;
  font-size: 0.95rem; letter-spacing: 0.06em; text-transform: uppercase;
  box-shadow: 0 3px 12px rgba(122,139,122,0.25);
}
.btn-back-config:hover {
  background: var(--zen-dark); transform: translateY(-1px);
}

.exec-main.transitioning .exec-activity-name,
.exec-main.transitioning .exec-activity-icon {
  animation: actChange 0.6s ease;
}
@keyframes actChange {
  0%{opacity:1;transform:translateY(0) scale(1);}
  40%{opacity:0;transform:translateY(-16px) scale(0.97);}
  60%{opacity:0;transform:translateY(16px) scale(0.97);}
  100%{opacity:1;transform:translateY(0) scale(1);}
}

.view-panel { padding: 0.5rem 1.25rem 6.5rem; }

/* Scrollbar */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }

/* ============ RESPONSIVE ============ */
@media (max-width: 480px) {
  .app-header { padding: 2rem 1rem 1rem; }
  .app-header h1 { font-size: 1.75rem; }
  .view-panel { padding: 0.35rem 0.875rem 6rem; }
  .card { padding: 1.15rem; border-radius: 20px; }
  .alarm-row { flex-direction: column; align-items: stretch; gap: 0.65rem; }
  .alarm-time-input { max-width: 100%; font-size: 2.25rem; }
  .exec-circle-wrap { width: 175px; height: 175px; }
  .exec-time-big { font-size: 2.8rem; }
  .exec-activity-name { font-size: 1.5rem; }
  .start-area { padding: 0.75rem 0.875rem; }
}
@media (max-width: 350px) {
  html { font-size: 15px; }
  .app-header h1 { font-size: 1.5rem; }
  .exec-circle-wrap { width: 155px; height: 155px; }
  .exec-time-big { font-size: 2.4rem; }
}
</style>
</head>
<body>

<div class="app" id="app">
  <header class="app-header">
    <h1>My <span>Miracle</span> Morning</h1>
    <p class="app-subtitle">Rituel matinal ¬∑ S√©r√©nit√©</p>
  </header>

  <div id="offlineBanner" class="offline-banner offline-status hidden">‚úàÔ∏è Mode hors-ligne ‚Äî donn√©es sauvegard√©es</div>
  <div id="installBanner" class="offline-banner install-prompt hidden" onclick="installApp()">
    <span>üì≤ Installer l'app</span>
    <span class="install-btn">Installer</span>
  </div>

  <div id="configView">
    <div class="view-panel">
      <div class="card">
        <div class="card-title"><span class="icon">‚è∞</span> R√©veil</div>
        <div class="alarm-row">
          <input type="time" id="alarmTime" class="alarm-time-input" value="06:00">
          <div class="alarm-toggles">
            <div class="toggle-wrap"><label class="toggle"><input type="checkbox" id="alarmEnabled"><span class="toggle-track"></span></label><span>Activ√©</span></div>
            <div class="toggle-wrap"><label class="toggle"><input type="checkbox" id="alarmAutoStart"><span class="toggle-track"></span></label><span>Auto-start routine</span></div>
          </div>
        </div>
        <div class="alarm-note">Le r√©veil n√©cessite que cette page reste ouverte.</div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">üìã</span> Routine</div>
        <div class="routine-header">
          <select id="routineSelect" class="routine-select"></select>
          <div class="routine-actions">
            <button class="icon-btn" onclick="renameRoutine()" title="Renommer">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="duplicateRoutine()" title="Dupliquer">üìë</button>
            <button class="icon-btn" onclick="createRoutine()" title="Nouvelle">‚ûï</button>
            <button class="icon-btn" onclick="deleteRoutine()" title="Supprimer" id="btnDeleteRoutine">üóëÔ∏è</button>
          </div>
        </div>
        <div class="routine-total" id="routineTotal"></div>
        <div class="activity-list" id="activityList"></div>
        <div class="add-activity-form">
          <div class="field"><label>Activit√©</label><input type="text" id="newActivityName" placeholder="Nom‚Ä¶"></div>
          <div class="field field-sm"><label>Min</label><input type="number" id="newActivityMin" min="0" max="99" value="5" style="text-align:center"></div>
          <div class="field field-sm"><label>Sec</label><input type="number" id="newActivitySec" min="0" max="59" value="0" style="text-align:center"></div>
          <button class="btn-add" onclick="addActivity()" title="Ajouter">+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="start-area" id="startArea">
    <button class="btn-start" id="btnStart" onclick="startRoutine()">üåÑ  D√©marrer la routine</button>
  </div>
</div>

<!-- EXECUTION VIEW -->
<div class="execution-view hidden" id="execView">
  <div class="exec-header">
    <button class="exec-close" onclick="stopRoutine()" title="Fermer">‚úï</button>
    <span class="exec-routine-name" id="execRoutineName"></span>
    <button class="exec-mute" id="btnMute" onclick="toggleMute()" title="Son">üîî</button>
  </div>
  <div class="exec-progress-bar"><div class="exec-progress-fill" id="execProgressFill"></div></div>
  <div class="exec-main" id="execMain">
    <div class="exec-activity-icon" id="execIcon"></div>
    <div class="exec-step-label" id="execStepLabel"></div>
    <div class="exec-activity-name" id="execActivityName"></div>
    <div class="exec-circle-wrap">
      <svg class="exec-circle-svg" viewBox="0 0 240 240">
        <defs><linearGradient id="zenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#95a695"/>
          <stop offset="100%" stop-color="#5f6f5f"/>
        </linearGradient></defs>
        <circle class="exec-circle-bg" cx="120" cy="120" r="106"></circle>
        <circle class="exec-circle-fg" id="execCircle" cx="120" cy="120" r="106"
          stroke-dasharray="666.106" stroke-dashoffset="0"></circle>
      </svg>
      <div class="exec-circle-time">
        <div class="exec-time-big" id="execTimeBig">00:00</div>
        <div class="exec-time-label">restant</div>
      </div>
    </div>
    <div class="exec-next" id="execNext"></div>
    <div class="exec-total-remaining" id="execTotalRemaining"></div>
  </div>
  <div class="exec-finished hidden" id="execFinished">
    <div class="done-icon">üèîÔ∏è</div><h2>Routine termin√©e</h2>
    <p>Ta matin√©e est lanc√©e. Bonne journ√©e.</p>
    <button class="btn-back-config" onclick="stopRoutine()">Retour</button>
  </div>
  <div class="exec-controls" id="execControls">
    <div class="exec-controls-main">
      <button class="ctrl-btn" id="btnPrev" onclick="prevActivity()" title="Pr√©c√©dent">‚èÆ</button>
      <button class="ctrl-btn-primary ctrl-btn" id="btnPlayPause" onclick="togglePause()">‚è∏</button>
      <button class="ctrl-btn" id="btnNext" onclick="nextActivity()" title="Suivant">‚è≠</button>
    </div>
    <div class="exec-controls-secondary">
      <button class="ctrl-btn-sm" id="btnRestart" onclick="restartRoutine()">‚Üª Recommencer</button>
      <button class="ctrl-btn-sm" id="btnLoop" onclick="toggleLoop()">üîÅ Boucle</button>
      <button class="ctrl-btn-sm" id="btnFullscreen" onclick="toggleFullscreen()">‚õ∂ Plein √©cran</button>
    </div>
  </div>
</div>

<!-- ALARM OVERLAY -->
<div class="alarm-overlay hidden" id="alarmOverlay">
  <div class="alarm-icon">üîî</div>
  <div class="alarm-time-display" id="alarmTimeDisplay">06:00</div>
  <div class="alarm-label">Miracle Morning</div>
  <button class="btn-stop-alarm" onclick="stopAlarm()">Arr√™ter le r√©veil</button>
</div>

<!-- MODAL -->
<div class="modal-backdrop hidden" id="modalBackdrop" onclick="closeModal(event)">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/* ================================================================
   PWA ‚Äî Service Worker
   ================================================================ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(r => {
      console.log('SW registered');
    }).catch(e => console.log('SW failed:', e.message));
  });
}

let deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredInstallPrompt = e;
  document.getElementById('installBanner').classList.remove('hidden');
});
function installApp() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(() => {
    document.getElementById('installBanner').classList.add('hidden');
    deferredInstallPrompt = null;
  });
}
window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden');
  deferredInstallPrompt = null;
});

function updateOnlineStatus() {
  const b = document.getElementById('offlineBanner');
  navigator.onLine ? b.classList.add('hidden') : b.classList.remove('hidden');
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

/* ================================================================
   DATA & STATE
   ================================================================ */
const ICONS = {
  'respiration':'üå¨Ô∏è','m√©ditation':'üßò','lecture':'üìñ','√©chauffement':'ü§∏',
  'danse':'üíÉ','sport':'üèãÔ∏è','douche':'üöø','√©criture':'‚úçÔ∏è','planification':'üìù',
  'yoga':'üßò‚Äç‚ôÄÔ∏è','marche':'üö∂','course':'üèÉ','musique':'üéµ','journal':'üìì',
  'affirmations':'üíõ','visualisation':'üîÆ','gratitude':'üôè','petit-d√©jeuner':'‚òï',
  'stretching':'ü§∏‚Äç‚ôÄÔ∏è','default':'‚ú®'
};
function gIcon(n) {
  const l = n.toLowerCase();
  for (const [k,v] of Object.entries(ICONS)) if (l.includes(k)) return v;
  return ICONS.default;
}

const DEF_ROUTINES = [{
  id:'default', name:'Miracle Morning', activities:[
    {id:'a1',name:'Respiration',duration:300},
    {id:'a2',name:'M√©ditation',duration:600},
    {id:'a3',name:'Lecture',duration:600},
    {id:'a4',name:'√âchauffement',duration:300},
    {id:'a5',name:'Danse / mise en mouvement',duration:300},
    {id:'a6',name:'Sport',duration:1200},
    {id:'a7',name:'Douche',duration:600},
    {id:'a8',name:'√âcriture',duration:900},
    {id:'a9',name:'Planification',duration:420}
  ]
}];

let state = {
  routines:[], activeRoutineId:'default',
  alarm:{time:'06:00',enabled:false,autoStart:false}, muted:false
};
let exec = {
  running:false, paused:false, loop:false, currentIndex:0,
  activityStartTime:0, pausedElapsed:0, intervalId:null,
  alarmIntervalId:null, alarmRinging:false
};

const SK = 'miracleMorning_v3';
function save() { try { localStorage.setItem(SK, JSON.stringify(state)); } catch(e) {} }
function load() {
  try {
    const r = localStorage.getItem(SK);
    if (r) {
      const s = JSON.parse(r);
      state.routines = s.routines || clone(DEF_ROUTINES);
      state.activeRoutineId = s.activeRoutineId || state.routines[0]?.id;
      state.alarm = {...state.alarm, ...s.alarm};
      state.muted = s.muted || false;
    } else {
      state.routines = clone(DEF_ROUTINES);
    }
  } catch(e) { state.routines = clone(DEF_ROUTINES); }
  if (!state.routines.length) state.routines = clone(DEF_ROUTINES);
  if (!state.routines.find(r => r.id === state.activeRoutineId))
    state.activeRoutineId = state.routines[0].id;
}

function clone(o) { return JSON.parse(JSON.stringify(o)); }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function fmt(s) { return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function fmtL(s) { const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return h>0 ? `${h}h${String(m).padStart(2,'0')}` : `${m} min`; }
function gR() { return state.routines.find(r => r.id === state.activeRoutineId); }
function tD(r) { return (r?.activities||[]).reduce((s,a) => s+a.duration, 0); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

/* ================================================================
   AUDIO ‚Äî Zen Singing Bowl (Web Audio API)
   ================================================================ */
let audioCtx = null;
function gAC() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// Soft chime between activities
function playChime() {
  if (state.muted) return;
  try {
    const c = gAC();
    const t = c.currentTime;
    // Two gentle sine tones
    [523.25, 783.99].forEach((freq, i) => {
      const o = c.createOscillator();
      const g = c.createGain();
      o.connect(g); g.connect(c.destination);
      o.type = 'sine';
      o.frequency.value = freq;
      g.gain.setValueAtTime(0, t + i*0.15);
      g.gain.linearRampToValueAtTime(0.08, t + i*0.15 + 0.1);
      g.gain.exponentialRampToValueAtTime(0.001, t + i*0.15 + 1.5);
      o.start(t + i*0.15);
      o.stop(t + i*0.15 + 1.5);
    });
  } catch(e) {}
}

// Singing bowl alarm ‚Äî warm, gentle, meditative
let alarmNodes = [];
function playSingingBowl() {
  if (state.muted) return;
  stopAlarmSnd();
  try {
    const c = gAC();

    function bowl() {
      const t = c.currentTime;
      // Fundamental + harmonics (like a real singing bowl)
      const freqs = [261.6, 392.0, 523.3, 659.3]; // C4, G4, C5, E5
      const gains = [0.06, 0.04, 0.03, 0.02];

      freqs.forEach((freq, i) => {
        const o = c.createOscillator();
        const g = c.createGain();
        o.connect(g); g.connect(c.destination);
        o.type = 'sine';
        o.frequency.value = freq;
        // Slight detuning for warmth
        o.detune.value = Math.random() * 6 - 3;
        // Slow attack, long gentle decay
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(gains[i], t + 0.8);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 6);
        o.start(t);
        o.stop(t + 6.5);
      });
    }

    // First bowl strike
    bowl();
    // Repeat every 5 seconds (gentle, not aggressive)
    const id = setInterval(bowl, 5000);
    alarmNodes.push(id);
  } catch(e) {}
}

function stopAlarmSnd() {
  alarmNodes.forEach(id => clearInterval(id));
  alarmNodes = [];
}

function vibrate() { if (navigator.vibrate) navigator.vibrate([150, 200, 150]); }

/* ================================================================
   RENDER
   ================================================================ */
function renderConfig() {
  document.getElementById('alarmTime').value = state.alarm.time;
  document.getElementById('alarmEnabled').checked = state.alarm.enabled;
  document.getElementById('alarmAutoStart').checked = state.alarm.autoStart;
  const sel = document.getElementById('routineSelect');
  sel.innerHTML = state.routines.map(r =>
    `<option value="${r.id}" ${r.id===state.activeRoutineId?'selected':''}>${r.name}</option>`
  ).join('');
  document.getElementById('btnDeleteRoutine').disabled = state.routines.length <= 1;
  renderActs();
}

function renderActs() {
  const routine = gR(); if (!routine) return;
  const total = tD(routine);
  document.getElementById('routineTotal').innerHTML =
    `Dur√©e totale : <strong>${fmtL(total)}</strong> ‚Äî ${routine.activities.length} activit√©${routine.activities.length>1?'s':''}`;

  const gripSVG = '<svg viewBox="0 0 24 24"><circle cx="8" cy="6" r="1.8" /><circle cx="16" cy="6" r="1.8" /><circle cx="8" cy="12" r="1.8" /><circle cx="16" cy="12" r="1.8" /><circle cx="8" cy="18" r="1.8" /><circle cx="16" cy="18" r="1.8" /></svg>';

  document.getElementById('activityList').innerHTML = routine.activities.map((a, i) => `
    <div class="activity-item" data-index="${i}">
      <span class="activity-grip" data-drag="handle">${gripSVG}</span>
      <span class="activity-icon-col">${gIcon(a.name)}</span>
      <div class="activity-info"><div class="activity-name">${esc(a.name)}</div></div>
      <div class="activity-duration">${fmt(a.duration)}</div>
      <div class="activity-actions">
        <button onclick="editAct('${a.id}')" title="Modifier">‚úèÔ∏è</button>
        <button class="del-btn" onclick="delAct('${a.id}')" title="Supprimer">‚úï</button>
      </div>
    </div>`).join('');

  // Re-bind touch drag & drop
  initTouchDragDrop();
}

/* ================================================================
   TOUCH DRAG & DROP ‚Äî Works on mobile & desktop
   ================================================================ */
function initTouchDragDrop() {
  const list = document.getElementById('activityList');
  const items = list.querySelectorAll('.activity-item');
  let dragItem = null;
  let ghost = null;
  let startY = 0;
  let dragIndex = -1;
  let currentOverIndex = -1;
  let longPressTimer = null;
  let isDragging = false;

  items.forEach(item => {
    const handle = item.querySelector('[data-drag="handle"]');

    // --- TOUCH ---
    handle.addEventListener('touchstart', onTouchStart, { passive: false });

    // --- MOUSE (desktop fallback) ---
    handle.addEventListener('mousedown', onMouseDown);
  });

  function onTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const item = e.target.closest('.activity-item');
    if (!item) return;
    startDrag(item, touch.clientY);

    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend', onTouchEnd);
  }

  function onTouchMove(e) {
    e.preventDefault();
    if (!isDragging) return;
    moveDrag(e.touches[0].clientY);
  }

  function onTouchEnd() {
    endDrag();
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchEnd);
  }

  function onMouseDown(e) {
    const item = e.target.closest('.activity-item');
    if (!item) return;
    e.preventDefault();
    startDrag(item, e.clientY);

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  function onMouseMove(e) {
    if (!isDragging) return;
    moveDrag(e.clientY);
  }

  function onMouseUp() {
    endDrag();
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  function startDrag(item, y) {
    isDragging = true;
    dragIndex = +item.dataset.index;
    dragItem = item;
    startY = y;

    // Create ghost
    const rect = item.getBoundingClientRect();
    ghost = item.cloneNode(true);
    ghost.classList.add('drag-ghost');
    ghost.style.width = rect.width + 'px';
    ghost.style.left = rect.left + 'px';
    ghost.style.top = rect.top + 'px';
    document.body.appendChild(ghost);

    item.classList.add('dragging');
    navigator.vibrate?.([30]);
  }

  function moveDrag(y) {
    if (!ghost || !isDragging) return;

    const delta = y - startY;
    const origRect = dragItem.getBoundingClientRect();
    ghost.style.top = (origRect.top + delta) + 'px';

    // Find which item we're over
    const allItems = list.querySelectorAll('.activity-item');
    let overIndex = -1;
    allItems.forEach((el, i) => {
      el.classList.remove('drag-over');
      if (i === dragIndex) return;
      const r = el.getBoundingClientRect();
      const mid = r.top + r.height / 2;
      if (y > r.top && y < r.bottom) {
        overIndex = i;
      }
    });

    if (overIndex >= 0 && overIndex !== dragIndex) {
      allItems[overIndex].classList.add('drag-over');
      currentOverIndex = overIndex;
    } else {
      currentOverIndex = -1;
    }
  }

  function endDrag() {
    if (!isDragging) return;
    isDragging = false;

    // Remove ghost
    if (ghost) { ghost.remove(); ghost = null; }

    // Remove visual states
    list.querySelectorAll('.activity-item').forEach(el => {
      el.classList.remove('dragging', 'drag-over');
    });

    // Perform swap
    if (currentOverIndex >= 0 && currentOverIndex !== dragIndex) {
      const routine = gR();
      const [moved] = routine.activities.splice(dragIndex, 1);
      routine.activities.splice(currentOverIndex, 0, moved);
      save();
      renderActs();
    }

    dragIndex = -1;
    currentOverIndex = -1;
  }
}

/* ================================================================
   EVENT LISTENERS
   ================================================================ */
document.getElementById('alarmTime').addEventListener('change', e => {
  state.alarm.time = e.target.value; save();
});
document.getElementById('alarmEnabled').addEventListener('change', e => {
  state.alarm.enabled = e.target.checked; save(); setupAlarm();
});
document.getElementById('alarmAutoStart').addEventListener('change', e => {
  state.alarm.autoStart = e.target.checked; save();
});

function setupAlarm() {
  if (exec.alarmIntervalId) clearInterval(exec.alarmIntervalId);
  if (!state.alarm.enabled) return;
  exec.alarmIntervalId = setInterval(() => {
    if (!state.alarm.enabled || exec.alarmRinging) return;
    const n = new Date();
    const [h,m] = state.alarm.time.split(':').map(Number);
    if (n.getHours()===h && n.getMinutes()===m && n.getSeconds()<2) triggerAlarm();
  }, 1000);
}

function triggerAlarm() {
  exec.alarmRinging = true;
  document.getElementById('alarmTimeDisplay').textContent = state.alarm.time;
  document.getElementById('alarmOverlay').classList.remove('hidden');
  playSingingBowl();
  vibrate();
}

function stopAlarm() {
  exec.alarmRinging = false;
  stopAlarmSnd();
  document.getElementById('alarmOverlay').classList.add('hidden');
  if (state.alarm.autoStart) startRoutine();
}

/* Routine CRUD */
document.getElementById('routineSelect').addEventListener('change', e => {
  state.activeRoutineId = e.target.value; save(); renderConfig();
});

function createRoutine() {
  showModal('Nouvelle routine', [{key:'name',label:'Nom',type:'text',value:''}], d => {
    if (!d.name.trim()) return;
    const r = {id:uid(), name:d.name.trim(), activities:[]};
    state.routines.push(r);
    state.activeRoutineId = r.id;
    save(); renderConfig();
  });
}
function renameRoutine() {
  const r = gR(); if (!r) return;
  showModal('Renommer', [{key:'name',label:'Nom',type:'text',value:r.name}], d => {
    if (!d.name.trim()) return;
    r.name = d.name.trim(); save(); renderConfig();
  });
}
function duplicateRoutine() {
  const r = gR(); if (!r) return;
  const c = clone(r); c.id = uid(); c.name = r.name+' (copie)';
  c.activities.forEach(a => a.id = uid());
  state.routines.push(c); state.activeRoutineId = c.id;
  save(); renderConfig();
}
function deleteRoutine() {
  if (state.routines.length <= 1) return;
  const r = gR();
  if (!confirm(`Supprimer ¬´ ${r.name} ¬ª ?`)) return;
  state.routines = state.routines.filter(x => x.id !== r.id);
  state.activeRoutineId = state.routines[0].id;
  save(); renderConfig();
}

/* Activity CRUD */
function addActivity() {
  const r = gR(); if (!r) return;
  const nE = document.getElementById('newActivityName');
  const mE = document.getElementById('newActivityMin');
  const sE = document.getElementById('newActivitySec');
  const name = nE.value.trim();
  if (!name) { nE.focus(); return; }
  const dur = (parseInt(mE.value)||0)*60 + (parseInt(sE.value)||0);
  if (dur <= 0) { mE.focus(); return; }
  r.activities.push({id:uid(), name, duration:dur});
  nE.value = ''; mE.value = '5'; sE.value = '0';
  save(); renderActs();
}
document.getElementById('newActivityName').addEventListener('keydown', e => {
  if (e.key === 'Enter') addActivity();
});

function editAct(id) {
  const r = gR(), a = r.activities.find(x => x.id === id);
  if (!a) return;
  showModal('Modifier', [
    {key:'name',label:'Nom',type:'text',value:a.name},
    {key:'min',label:'Minutes',type:'number',value:Math.floor(a.duration/60)},
    {key:'sec',label:'Secondes',type:'number',value:a.duration%60}
  ], d => {
    if (!d.name.trim()) return;
    a.name = d.name.trim();
    const dur = (parseInt(d.min)||0)*60 + (parseInt(d.sec)||0);
    if (dur > 0) a.duration = dur;
    save(); renderActs();
  });
}

function delAct(id) {
  const r = gR();
  r.activities = r.activities.filter(a => a.id !== id);
  save(); renderActs();
}

/* Modal */
function showModal(title, fields, onConfirm) {
  const bd = document.getElementById('modalBackdrop');
  const ct = document.getElementById('modalContent');
  let h = `<div class="modal-handle"></div><div class="modal-title">${title}</div>`;
  fields.forEach(f => {
    h += `<div class="modal-field"><label>${f.label}</label>
      <input type="${f.type}" id="modal_${f.key}" value="${f.value}"
      ${f.type==='number'?'min="0" max="99"':''}></div>`;
  });
  h += `<div class="modal-actions">
    <button class="btn-modal-cancel" onclick="closeModal()">Annuler</button>
    <button class="btn-modal-confirm" id="modalOk">Confirmer</button></div>`;
  ct.innerHTML = h;
  bd.classList.remove('hidden');
  setTimeout(() => {
    const f = ct.querySelector('input');
    if (f) { f.focus(); f.select(); }
  }, 100);
  document.getElementById('modalOk').onclick = () => {
    const d = {};
    fields.forEach(f => d[f.key] = document.getElementById(`modal_${f.key}`).value);
    closeModal(); onConfirm(d);
  };
  ct.querySelectorAll('input').forEach(i => {
    i.addEventListener('keydown', e => { if (e.key==='Enter') document.getElementById('modalOk').click(); });
  });
}
function closeModal(e) {
  if (e && e.target !== document.getElementById('modalBackdrop')) return;
  document.getElementById('modalBackdrop').classList.add('hidden');
}

/* ================================================================
   EXECUTION
   ================================================================ */
const CIRC = 2 * Math.PI * 106;

function startRoutine() {
  const r = gR();
  if (!r || !r.activities.length) return;
  exec.running = true; exec.paused = false;
  exec.currentIndex = 0; exec.pausedElapsed = 0;
  try { document.documentElement.requestFullscreen?.(); } catch(e) {}
  document.getElementById('configView').classList.add('hidden');
  document.getElementById('startArea').classList.add('hidden');
  document.getElementById('execView').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execRoutineName').textContent = r.name;
  updateMute(); updateLoop();
  startAct();
}

function startAct() {
  exec.activityStartTime = Date.now();
  exec.pausedElapsed = 0;
  renderExec(); startTick();
}

function renderExec() {
  const r = gR(), a = r.activities[exec.currentIndex];
  if (!a) return;
  const m = document.getElementById('execMain');
  m.classList.add('transitioning');
  setTimeout(() => m.classList.remove('transitioning'), 600);
  document.getElementById('execIcon').textContent = gIcon(a.name);
  document.getElementById('execStepLabel').textContent =
    `Activit√© ${exec.currentIndex+1} / ${r.activities.length}`;
  document.getElementById('execActivityName').textContent = a.name;
  const nx = r.activities[exec.currentIndex+1];
  document.getElementById('execNext').innerHTML = nx
    ? `Suivant : <strong>${esc(nx.name)}</strong>`
    : (exec.loop ? 'Suivant : ‚Üª Reprise' : 'Derni√®re activit√©');
  document.getElementById('btnPrev').disabled = exec.currentIndex === 0;
}

function startTick() {
  if (exec.intervalId) clearInterval(exec.intervalId);
  exec.intervalId = setInterval(tick, 250);
}

function tick() {
  if (!exec.running || exec.paused) return;
  const r = gR(); if (!r) return;
  const a = r.activities[exec.currentIndex]; if (!a) return;
  const el = Math.floor((Date.now()-exec.activityStartTime)/1000) + exec.pausedElapsed;
  const rem = Math.max(0, a.duration - el);
  document.getElementById('execTimeBig').textContent = fmt(rem);
  const p = a.duration > 0 ? (a.duration-rem)/a.duration : 1;
  document.getElementById('execCircle').style.strokeDashoffset = CIRC * (1-p);
  const tb = r.activities.slice(0,exec.currentIndex).reduce((s,x) => s+x.duration, 0);
  const ta = tD(r);
  const gp = ta > 0 ? (tb+(a.duration-rem))/ta : 0;
  document.getElementById('execProgressFill').style.width = (gp*100)+'%';
  const tr = r.activities.slice(exec.currentIndex+1).reduce((s,x) => s+x.duration, 0) + rem;
  document.getElementById('execTotalRemaining').textContent = `Restant : ${fmtL(tr)}`;
  if (rem <= 0) onActDone();
}

function onActDone() {
  playChime(); vibrate();
  const r = gR();
  if (exec.currentIndex < r.activities.length-1) {
    exec.currentIndex++; startAct();
  } else if (exec.loop) {
    exec.currentIndex = 0; startAct();
  } else onDone();
}

function onDone() {
  exec.running = false;
  if (exec.intervalId) clearInterval(exec.intervalId);
  try { document.exitFullscreen?.(); } catch(e) {}
  document.getElementById('execMain').classList.add('hidden');
  document.getElementById('execControls').classList.add('hidden');
  document.getElementById('execFinished').classList.remove('hidden');
  document.getElementById('execProgressFill').style.width = '100%';
}

function stopRoutine() {
  exec.running = false; exec.paused = false;
  if (exec.intervalId) clearInterval(exec.intervalId);
  try { document.exitFullscreen?.(); } catch(e) {}
  document.getElementById('execView').classList.add('hidden');
  document.getElementById('configView').classList.remove('hidden');
  document.getElementById('startArea').classList.remove('hidden');
}

function togglePause() {
  if (!exec.running) return;
  if (exec.paused) {
    exec.activityStartTime = Date.now();
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startTick();
  } else {
    exec.pausedElapsed += Math.floor((Date.now()-exec.activityStartTime)/1000);
    exec.paused = true;
    if (exec.intervalId) clearInterval(exec.intervalId);
    document.getElementById('btnPlayPause').textContent = '‚ñ∂';
  }
}

function nextActivity() {
  const r = gR(); if (!r) return;
  if (exec.currentIndex < r.activities.length-1) {
    exec.currentIndex++;
  } else if (exec.loop) {
    exec.currentIndex = 0;
  } else return;
  exec.paused = false;
  document.getElementById('btnPlayPause').textContent = '‚è∏';
  startAct();
}

function prevActivity() {
  if (exec.currentIndex > 0) {
    exec.currentIndex--;
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startAct();
  }
}

function restartRoutine() {
  exec.currentIndex = 0; exec.paused = false;
  document.getElementById('btnPlayPause').textContent = '‚è∏';
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  exec.running = true;
  startAct();
}

function toggleLoop() { exec.loop = !exec.loop; updateLoop(); }
function updateLoop() { document.getElementById('btnLoop').classList.toggle('active', exec.loop); }
function toggleMute() { state.muted = !state.muted; save(); updateMute(); }
function updateMute() {
  const b = document.getElementById('btnMute');
  b.textContent = state.muted ? 'üîá' : 'üîî';
  b.classList.toggle('muted', state.muted);
}
function toggleFullscreen() {
  if (document.fullscreenElement) document.exitFullscreen?.();
  else document.documentElement.requestFullscreen?.();
}

/* INIT */
load(); renderConfig(); setupAlarm();
document.addEventListener('click', () => {
  gAC();
  try { if ('wakeLock' in navigator) navigator.wakeLock.request('screen'); } catch(e) {}
}, { once: true });
</script>
</body>
</html>
