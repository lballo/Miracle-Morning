<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#F6F4F0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Miracle Morning">
<meta name="description" content="Timer de routine matinale ‚Äî Miracle Morning">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<title>My Miracle Morning</title>

<!-- Google Fonts ‚Äî progressive enhancement, app works without them -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" onload="document.body.classList.add('fonts-loaded')" onerror="">

<style>
/* ========================================
   CSS VARIABLES & RESET
   ======================================== */
:root {
  --bg: #F6F4F0;
  --bg-card: rgba(255,255,255,0.72);
  --bg-card-solid: #FFFFFF;
  --bg-warm: #EFEBE5;
  --bg-accent: #E6E0D8;
  --text: #1E1B18;
  --text-soft: #6B6360;
  --text-muted: #A49E98;
  --gold: #BF8A3D;
  --gold-light: #D4A85C;
  --gold-dark: #9A6E2E;
  --gold-bg: rgba(191,138,61,0.08);
  --gold-bg-strong: rgba(191,138,61,0.14);
  --danger: #C0504D;
  --danger-light: rgba(192,80,77,0.08);
  --border: rgba(0,0,0,0.06);
  --border-strong: rgba(0,0,0,0.10);
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 20px rgba(0,0,0,0.05), 0 2px 6px rgba(0,0,0,0.03);
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  /* System font stacks ‚Äî work offline, look great everywhere */
  --font-display: Georgia, 'Times New Roman', 'Noto Serif', serif;
  --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* When Google Fonts load, upgrade the stacks */
.fonts-loaded {
  --font-display: 'Playfair Display', Georgia, 'Times New Roman', serif;
  --font-body: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 18px; -webkit-text-size-adjust: 100%; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.65;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  background-image:
    radial-gradient(ellipse at 20% 0%, rgba(191,138,61,0.06) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 100%, rgba(191,138,61,0.04) 0%, transparent 50%);
  background-attachment: fixed;
}

.hidden { display: none !important; }

button {
  font-family: var(--font-body);
  cursor: pointer; border: none; background: none;
  font-size: 1rem; transition: var(--transition);
}
button:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

input, select {
  font-family: var(--font-body);
  font-size: 1rem;
  border: 1.5px solid var(--border-strong);
  border-radius: var(--radius-sm);
  padding: 0.8rem 1rem;
  background: var(--bg-card-solid);
  color: var(--text);
  transition: var(--transition);
  outline: none; width: 100%;
}
input:focus, select:focus { border-color: var(--gold); box-shadow: 0 0 0 4px rgba(191,138,61,0.10); }

/* ========================================
   LAYOUT
   ======================================== */
.app { max-width: 720px; margin: 0 auto; min-height: 100dvh; }

/* HEADER */
.app-header { padding: 2.25rem 1.75rem 1.5rem; text-align: center; }
.app-header h1 {
  font-family: var(--font-display);
  font-size: 2.5rem; font-weight: 400;
  letter-spacing: -0.01em; line-height: 1.2;
}
.app-header h1 span { color: var(--gold); font-style: italic; }

.app-subtitle {
  font-size: 0.95rem; color: var(--text-muted);
  margin-top: 0.35rem; letter-spacing: 0.04em;
}

/* Offline / Install banner */
.offline-banner {
  margin: 0 1.75rem 0.5rem;
  padding: 0.55rem 1rem;
  border-radius: var(--radius-sm);
  font-size: 0.8rem; font-weight: 500;
  display: flex; align-items: center; gap: 0.5rem;
  animation: fadeIn 0.3s ease;
}

.offline-banner.offline-status {
  background: rgba(191,138,61,0.10); color: var(--gold-dark);
  border: 1px solid rgba(191,138,61,0.15);
}

.offline-banner.install-prompt {
  background: var(--bg-card-solid); color: var(--text);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  justify-content: space-between;
  cursor: pointer;
}

.offline-banner.install-prompt:hover { border-color: var(--gold); }

.install-btn {
  padding: 0.35rem 0.75rem;
  border-radius: 8px;
  background: var(--gold); color: white;
  font-size: 0.75rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.05em;
}

/* ========================================
   CARDS
   ======================================== */
.card {
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.75rem 2rem;
  margin-bottom: 1.25rem;
  box-shadow: var(--shadow-md);
}

.card-title {
  font-family: var(--font-display);
  font-size: 1.5rem; font-weight: 500;
  margin-bottom: 1.15rem;
  display: flex; align-items: center; gap: 0.65rem;
}
.card-title .icon { font-size: 1.35rem; }

/* ========================================
   ALARM
   ======================================== */
.alarm-row { display: flex; align-items: center; gap: 1.15rem; margin-bottom: 1.15rem; }

.alarm-time-input {
  font-family: var(--font-display);
  font-size: 2.75rem; font-weight: 400;
  text-align: center; width: 260px;
  padding: 0.6rem 1rem; letter-spacing: 0.04em;
  border: 1.5px solid var(--border-strong);
  border-radius: var(--radius-md);
}
.alarm-time-input:focus { border-color: var(--gold); box-shadow: 0 0 0 4px rgba(191,138,61,0.10); }

.alarm-toggles { display: flex; flex-direction: column; gap: 0.75rem; flex: 1; }

.toggle-wrap {
  display: flex; align-items: center; gap: 0.75rem;
  font-size: 1rem; color: var(--text-soft); font-weight: 500;
}

.toggle { position: relative; width: 54px; height: 30px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-track {
  position: absolute; inset: 0;
  background: var(--bg-accent); border-radius: 15px;
  border: 1.5px solid var(--border-strong);
  cursor: pointer; transition: var(--transition);
}
.toggle-track::after {
  content: ''; position: absolute;
  top: 3px; left: 3px; width: 22px; height: 22px;
  background: white; border-radius: 50%;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12); transition: var(--transition);
}
.toggle input:checked + .toggle-track { background: var(--gold); border-color: var(--gold-dark); }
.toggle input:checked + .toggle-track::after { transform: translateX(24px); }

.alarm-note {
  font-size: 0.85rem; color: var(--text-muted); line-height: 1.5;
  padding: 0.7rem 0.9rem; background: var(--gold-bg);
  border-radius: var(--radius-sm); border: 1px solid rgba(191,138,61,0.08);
}

/* ========================================
   ROUTINE
   ======================================== */
.routine-header { display: flex; align-items: center; gap: 0.625rem; margin-bottom: 1.15rem; flex-wrap: wrap; }

.routine-select {
  flex: 1; min-width: 150px;
  font-size: 1.05rem; font-weight: 600;
  padding: 0.8rem 1.1rem; border-radius: var(--radius-sm);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%236B6360' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.875rem center;
  padding-right: 2.5rem;
}

.routine-actions { display: flex; gap: 0.4rem; }

.icon-btn {
  width: 48px; height: 48px;
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-warm); color: var(--text-soft);
  font-size: 1.15rem; border: 1px solid var(--border);
}
.icon-btn:hover { background: var(--bg-accent); color: var(--text); transform: translateY(-1px); }

.routine-total {
  font-size: 1rem; color: var(--text-soft);
  margin-bottom: 1.15rem; padding: 0.7rem 1rem;
  background: var(--gold-bg); border-radius: var(--radius-sm);
  border: 1px solid rgba(191,138,61,0.06);
}
.routine-total strong { color: var(--gold-dark); font-weight: 700; }

/* ========================================
   ACTIVITY LIST
   ======================================== */
.activity-list { display: flex; flex-direction: column; gap: 0.625rem; }

.activity-item {
  display: flex; align-items: center; gap: 0.75rem;
  padding: 1rem 1.15rem; background: var(--bg-warm);
  border-radius: var(--radius-md); border: 1.5px solid transparent;
  transition: var(--transition); min-height: 72px;
}
.activity-item:hover { border-color: var(--border-strong); background: var(--bg-accent); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.activity-item.dragging { opacity: 0.4; border-color: var(--gold); }
.activity-item.drag-over { border-color: var(--gold); background: var(--gold-bg); }

.activity-grip { cursor: grab; color: var(--text-muted); font-size: 1.1rem; padding: 0.3rem; touch-action: none; user-select: none; }
.activity-grip:active { cursor: grabbing; }

.activity-icon-col {
  font-size: 1.65rem; width: 48px; height: 48px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-card-solid); border-radius: var(--radius-sm);
  flex-shrink: 0; box-shadow: var(--shadow-sm);
}

.activity-info { flex: 1; min-width: 0; }
.activity-name {
  font-size: 1.1rem; font-weight: 600; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.activity-duration {
  font-family: var(--font-display);
  font-size: 1.25rem; color: var(--gold-dark);
  font-weight: 500; letter-spacing: 0.02em; white-space: nowrap;
}

.activity-actions { display: flex; gap: 0.2rem; }
.activity-actions button {
  width: 40px; height: 40px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; color: var(--text-muted);
}
.activity-actions button:hover { background: var(--bg-card-solid); color: var(--text); }
.activity-actions .del-btn:hover { background: var(--danger-light); color: var(--danger); }

/* Add form */
.add-activity-form { display: flex; gap: 0.625rem; margin-top: 1.25rem; align-items: flex-end; }
.add-activity-form .field { flex: 1; }
.add-activity-form .field-sm { width: 82px; flex-shrink: 0; }

.field label {
  display: block; font-size: 0.8rem;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 600;
}
.field input { font-size: 1rem; padding: 0.75rem 0.85rem; }

.btn-add {
  height: 50px; width: 50px; flex-shrink: 0;
  border-radius: var(--radius-sm);
  background: var(--gold); color: white; font-size: 1.6rem;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 3px 12px rgba(191,138,61,0.3);
}
.btn-add:hover { background: var(--gold-dark); transform: translateY(-2px); }

/* ========================================
   START BUTTON
   ======================================== */
.start-area {
  position: fixed; bottom: 0;
  left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 720px;
  padding: 1.25rem 1.75rem;
  padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
  background: linear-gradient(to top, var(--bg) 50%, transparent);
  z-index: 50;
}

.btn-start {
  width: 100%; padding: 1.25rem;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: white; font-size: 1.15rem; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase;
  box-shadow: 0 6px 24px rgba(191,138,61,0.35);
  position: relative; overflow: hidden;
}
.btn-start::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.15));
  opacity: 0; transition: var(--transition);
}
.btn-start:hover::before { opacity: 1; }
.btn-start:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(191,138,61,0.45); }

/* ========================================
   EXECUTION VIEW
   ======================================== */
.execution-view {
  position: fixed; inset: 0; z-index: 100;
  background: var(--bg);
  background-image:
    radial-gradient(ellipse at 50% 20%, rgba(191,138,61,0.07) 0%, transparent 60%),
    radial-gradient(ellipse at 50% 80%, rgba(191,138,61,0.04) 0%, transparent 50%);
  display: flex; flex-direction: column; overflow: hidden;
}

.exec-header {
  padding: 1.25rem 1.5rem 0.75rem;
  display: flex; align-items: center; justify-content: space-between;
}

.exec-close, .exec-mute {
  width: 46px; height: 46px; border-radius: var(--radius-sm);
  background: var(--bg-warm); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; color: var(--text-soft);
}
.exec-close:hover, .exec-mute:hover { background: var(--bg-accent); }
.exec-mute.muted { color: var(--danger); background: var(--danger-light); }

.exec-routine-name {
  font-family: var(--font-display);
  font-size: 1.15rem; font-weight: 400;
  color: var(--text-soft); font-style: italic;
}

.exec-progress-bar {
  height: 4px; background: var(--bg-accent);
  margin: 0.25rem 1.5rem 0; border-radius: 2px; overflow: hidden;
}
.exec-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold-light), var(--gold-dark));
  border-radius: 2px; transition: width 0.5s linear;
}

.exec-main {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 1.5rem; text-align: center;
}

.exec-activity-icon { font-size: 3.5rem; margin-bottom: 0.5rem; animation: pulseIcon 3s ease-in-out infinite; }
@keyframes pulseIcon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

.exec-step-label {
  font-size: 0.85rem; text-transform: uppercase;
  letter-spacing: 0.15em; color: var(--text-muted);
  margin-bottom: 0.35rem; font-weight: 600;
}

.exec-activity-name {
  font-family: var(--font-display);
  font-size: 2.4rem; font-weight: 500; color: var(--text);
  margin-bottom: 1.75rem; line-height: 1.15;
}

.exec-circle-wrap { position: relative; width: 240px; height: 240px; margin-bottom: 1.75rem; }
.exec-circle-svg {
  transform: rotate(-90deg); width: 100%; height: 100%;
  filter: drop-shadow(0 4px 12px rgba(191,138,61,0.15));
}
.exec-circle-bg { fill: none; stroke: var(--bg-accent); stroke-width: 5; }
.exec-circle-fg {
  fill: none; stroke: url(#goldGradient);
  stroke-width: 5; stroke-linecap: round;
  transition: stroke-dashoffset 0.5s linear;
}
.exec-circle-time {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.exec-time-big {
  font-family: var(--font-display);
  font-size: 4rem; font-weight: 400;
  letter-spacing: 0.02em; color: var(--text); line-height: 1;
}
.exec-time-label {
  font-size: 0.85rem; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--text-muted);
  margin-top: 0.35rem; font-weight: 500;
}

.exec-next { font-size: 1rem; color: var(--text-muted); margin-bottom: 0.35rem; }
.exec-next strong { color: var(--text-soft); font-weight: 600; }
.exec-total-remaining { font-size: 0.9rem; color: var(--text-muted); }

/* Controls */
.exec-controls {
  padding: 1rem 1.5rem;
  padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
  display: flex; flex-direction: column; gap: 0.75rem;
  background: linear-gradient(to top, rgba(246,244,240,0.95), transparent);
}
.exec-controls-main { display: flex; align-items: center; justify-content: center; gap: 1rem; }

.ctrl-btn {
  width: 54px; height: 54px; border-radius: var(--radius-md);
  background: var(--bg-card); backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; color: var(--text-soft); box-shadow: var(--shadow-sm);
}
.ctrl-btn:hover { background: var(--bg-accent); color: var(--text); transform: translateY(-2px); box-shadow: var(--shadow-md); }

.ctrl-btn-primary {
  width: 72px; height: 72px;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: white; font-size: 1.65rem; border: none;
  box-shadow: 0 6px 20px rgba(191,138,61,0.35);
  border-radius: var(--radius-lg);
}
.ctrl-btn-primary:hover { transform: scale(1.06) translateY(-2px); }

.exec-controls-secondary { display: flex; justify-content: center; gap: 0.5rem; }
.ctrl-btn-sm {
  padding: 0.5rem 1rem; border-radius: var(--radius-sm);
  font-size: 0.8rem; font-weight: 600; color: var(--text-muted);
  background: var(--bg-card); border: 1px solid var(--border);
  text-transform: uppercase; letter-spacing: 0.06em;
}
.ctrl-btn-sm:hover { color: var(--text); background: var(--bg-accent); }
.ctrl-btn-sm.active { color: var(--gold-dark); background: var(--gold-bg-strong); border-color: var(--gold-light); }

/* ========================================
   ALARM OVERLAY
   ======================================== */
.alarm-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: linear-gradient(160deg, #1E1B18, #2C2520 40%, #1a1612);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; color: white; animation: fadeIn 0.5s ease;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.alarm-overlay .alarm-icon { font-size: 5rem; animation: alarmRing 0.5s ease-in-out infinite alternate; margin-bottom: 1.5rem; }
@keyframes alarmRing { from { transform: rotate(-18deg); } to { transform: rotate(18deg) scale(1.05); } }

.alarm-overlay .alarm-time-display {
  font-family: var(--font-display);
  font-size: 5rem; font-weight: 400; letter-spacing: 0.04em;
  margin-bottom: 0.5rem; color: var(--gold-light);
  text-shadow: 0 2px 20px rgba(191,138,61,0.4);
}
.alarm-overlay .alarm-label {
  font-size: 1rem; color: rgba(255,255,255,0.4);
  text-transform: uppercase; letter-spacing: 0.2em;
  margin-bottom: 3rem; font-weight: 500;
}

.btn-stop-alarm {
  padding: 1.15rem 3rem; border-radius: 60px;
  background: var(--gold); color: white;
  font-size: 1.1rem; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase;
  box-shadow: 0 6px 30px rgba(191,138,61,0.5);
  animation: pulseBtn 2s ease-in-out infinite;
}
@keyframes pulseBtn { 0%,100%{box-shadow:0 6px 30px rgba(191,138,61,0.5);}50%{box-shadow:0 6px 50px rgba(191,138,61,0.8);} }

/* ========================================
   MODAL
   ======================================== */
.modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(30,27,24,0.45);
  backdrop-filter: blur(6px); z-index: 300;
  display: flex; align-items: flex-end; justify-content: center;
  animation: fadeIn 0.2s ease;
}

.modal {
  background: var(--bg-card-solid);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  padding: 2rem 1.5rem;
  padding-bottom: max(2rem, env(safe-area-inset-bottom));
  width: 100%; max-width: 720px; max-height: 80dvh;
  overflow-y: auto;
  animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal-handle { width: 40px; height: 4px; background: var(--bg-accent); border-radius: 2px; margin: 0 auto 1.25rem; }
.modal-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 500; margin-bottom: 1.25rem; }
.modal-field { margin-bottom: 1.15rem; }
.modal-field label {
  display: block; font-size: 0.8rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--text-muted);
  margin-bottom: 0.4rem; font-weight: 600;
}

.modal-actions { display: flex; gap: 0.625rem; margin-top: 1.5rem; }
.modal-actions button { flex: 1; padding: 0.9rem; border-radius: var(--radius-md); font-weight: 600; font-size: 1rem; }
.btn-modal-cancel { background: var(--bg-warm); color: var(--text-soft); border: 1px solid var(--border-strong); }
.btn-modal-cancel:hover { background: var(--bg-accent); }
.btn-modal-confirm { background: var(--gold); color: white; box-shadow: 0 3px 12px rgba(191,138,61,0.25); }
.btn-modal-confirm:hover { background: var(--gold-dark); }

/* FINISHED */
.exec-finished {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; padding: 2rem;
}
.exec-finished .done-icon { font-size: 5rem; margin-bottom: 1.25rem; }
.exec-finished h2 { font-family: var(--font-display); font-size: 2.4rem; font-weight: 400; margin-bottom: 0.5rem; }
.exec-finished p { color: var(--text-soft); font-size: 1.1rem; margin-bottom: 2.5rem; }
.btn-back-config {
  padding: 1rem 2.5rem; border-radius: var(--radius-lg);
  background: var(--gold); color: white; font-weight: 700;
  font-size: 1rem; letter-spacing: 0.06em; text-transform: uppercase;
  box-shadow: 0 4px 16px rgba(191,138,61,0.3);
}
.btn-back-config:hover { background: var(--gold-dark); transform: translateY(-2px); }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }

.exec-main.transitioning .exec-activity-name,
.exec-main.transitioning .exec-activity-icon { animation: actChange 0.6s ease; }
@keyframes actChange {
  0%{opacity:1;transform:translateY(0) scale(1);}
  40%{opacity:0;transform:translateY(-24px) scale(0.95);}
  60%{opacity:0;transform:translateY(24px) scale(0.95);}
  100%{opacity:1;transform:translateY(0) scale(1);}
}

.completion-flash { animation: flashGold 0.7s ease; }
@keyframes flashGold { 0%{background-color:var(--bg);}30%{background-color:rgba(191,138,61,0.06);}100%{background-color:var(--bg);} }

.view-panel { padding: 0.5rem 1.75rem 7.5rem; animation: fadeIn 0.3s ease; }
</style>
</head>
<body>

<div class="app" id="app">
  <header class="app-header">
    <h1>My <span>Miracle</span> Morning</h1>
    <p class="app-subtitle">Rituel matinal ¬∑ Routine quotidienne</p>
  </header>

  <!-- Offline/Install banners -->
  <div id="offlineBanner" class="offline-banner offline-status hidden">
    ‚úàÔ∏è Mode hors-ligne ‚Äî vos donn√©es sont sauvegard√©es localement
  </div>
  <div id="installBanner" class="offline-banner install-prompt hidden" onclick="installApp()">
    <span>üì≤ Installer l'app sur votre appareil</span>
    <span class="install-btn">Installer</span>
  </div>

  <div id="configView">
    <div class="view-panel">
      <!-- ALARM -->
      <div class="card">
        <div class="card-title"><span class="icon">‚è∞</span> R√©veil</div>
        <div class="alarm-row">
          <input type="time" id="alarmTime" class="alarm-time-input" value="06:00">
          <div class="alarm-toggles">
            <div class="toggle-wrap">
              <label class="toggle"><input type="checkbox" id="alarmEnabled"><span class="toggle-track"></span></label>
              <span>Activ√©</span>
            </div>
            <div class="toggle-wrap">
              <label class="toggle"><input type="checkbox" id="alarmAutoStart"><span class="toggle-track"></span></label>
              <span>Auto-start routine</span>
            </div>
          </div>
        </div>
        <div class="alarm-note">‚ö†Ô∏è Le r√©veil n√©cessite que cette page reste ouverte dans votre navigateur.</div>
      </div>

      <!-- ROUTINE -->
      <div class="card">
        <div class="card-title"><span class="icon">üìã</span> Routine</div>
        <div class="routine-header">
          <select id="routineSelect" class="routine-select"></select>
          <div class="routine-actions">
            <button class="icon-btn" onclick="renameRoutine()" title="Renommer">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="duplicateRoutine()" title="Dupliquer">üìë</button>
            <button class="icon-btn" onclick="createRoutine()" title="Nouvelle">‚ûï</button>
            <button class="icon-btn" onclick="deleteRoutine()" title="Supprimer" id="btnDeleteRoutine">üóëÔ∏è</button>
          </div>
        </div>
        <div class="routine-total" id="routineTotal"></div>
        <div class="activity-list" id="activityList"></div>
        <div class="add-activity-form">
          <div class="field"><label>Activit√©</label><input type="text" id="newActivityName" placeholder="Nom‚Ä¶"></div>
          <div class="field field-sm"><label>Min</label><input type="number" id="newActivityMin" min="0" max="99" value="5" style="text-align:center"></div>
          <div class="field field-sm"><label>Sec</label><input type="number" id="newActivitySec" min="0" max="59" value="0" style="text-align:center"></div>
          <button class="btn-add" onclick="addActivity()" title="Ajouter">+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="start-area" id="startArea">
    <button class="btn-start" id="btnStart" onclick="startRoutine()">‚òÄÔ∏è  D√©marrer la routine</button>
  </div>
</div>

<!-- EXECUTION -->
<div class="execution-view hidden" id="execView">
  <div class="exec-header">
    <button class="exec-close" onclick="stopRoutine()" title="Fermer">‚úï</button>
    <span class="exec-routine-name" id="execRoutineName"></span>
    <button class="exec-mute" id="btnMute" onclick="toggleMute()" title="Son">üîî</button>
  </div>
  <div class="exec-progress-bar"><div class="exec-progress-fill" id="execProgressFill"></div></div>
  <div class="exec-main" id="execMain">
    <div class="exec-activity-icon" id="execIcon"></div>
    <div class="exec-step-label" id="execStepLabel"></div>
    <div class="exec-activity-name" id="execActivityName"></div>
    <div class="exec-circle-wrap">
      <svg class="exec-circle-svg" viewBox="0 0 240 240">
        <defs><linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#D4A85C"/><stop offset="100%" stop-color="#9A6E2E"/>
        </linearGradient></defs>
        <circle class="exec-circle-bg" cx="120" cy="120" r="106"></circle>
        <circle class="exec-circle-fg" id="execCircle" cx="120" cy="120" r="106" stroke-dasharray="666.106" stroke-dashoffset="0"></circle>
      </svg>
      <div class="exec-circle-time">
        <div class="exec-time-big" id="execTimeBig">00:00</div>
        <div class="exec-time-label">restant</div>
      </div>
    </div>
    <div class="exec-next" id="execNext"></div>
    <div class="exec-total-remaining" id="execTotalRemaining"></div>
  </div>
  <div class="exec-finished hidden" id="execFinished">
    <div class="done-icon">‚òÄÔ∏è</div><h2>Routine termin√©e !</h2>
    <p>Bravo, ta matin√©e est lanc√©e.</p>
    <button class="btn-back-config" onclick="stopRoutine()">Retour</button>
  </div>
  <div class="exec-controls" id="execControls">
    <div class="exec-controls-main">
      <button class="ctrl-btn" id="btnPrev" onclick="prevActivity()" title="Pr√©c√©dent">‚èÆ</button>
      <button class="ctrl-btn-primary ctrl-btn" id="btnPlayPause" onclick="togglePause()">‚è∏</button>
      <button class="ctrl-btn" id="btnNext" onclick="nextActivity()" title="Suivant">‚è≠</button>
    </div>
    <div class="exec-controls-secondary">
      <button class="ctrl-btn-sm" id="btnRestart" onclick="restartRoutine()">‚Üª Recommencer</button>
      <button class="ctrl-btn-sm" id="btnLoop" onclick="toggleLoop()">üîÅ Boucle</button>
      <button class="ctrl-btn-sm" id="btnFullscreen" onclick="toggleFullscreen()">‚õ∂ Plein √©cran</button>
    </div>
  </div>
</div>

<!-- ALARM OVERLAY -->
<div class="alarm-overlay hidden" id="alarmOverlay">
  <div class="alarm-icon">üîî</div>
  <div class="alarm-time-display" id="alarmTimeDisplay">06:00</div>
  <div class="alarm-label">Miracle Morning</div>
  <button class="btn-stop-alarm" onclick="stopAlarm()">Arr√™ter le r√©veil</button>
</div>

<!-- MODAL -->
<div class="modal-backdrop hidden" id="modalBackdrop" onclick="closeModal(event)">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/* ================================================================
   SERVICE WORKER ‚Äî Offline Support (PWA)
   ================================================================
   Registers the external service worker (sw.js).
   Cache-first strategy for offline support.
   ================================================================ */
if ('serviceWorker' in navigator && location.protocol !== 'file:') {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('Service Worker registered, scope:', reg.scope);
  }).catch(err => {
    console.log('SW registration failed:', err.message);
  });
}

/* ================================================================
   PWA INSTALL PROMPT
   ================================================================ */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  document.getElementById('installBanner').classList.remove('hidden');
});

function installApp() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(result => {
    document.getElementById('installBanner').classList.add('hidden');
    deferredInstallPrompt = null;
  });
}

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden');
  deferredInstallPrompt = null;
});

/* ================================================================
   OFFLINE / ONLINE STATUS
   ================================================================ */
function updateOnlineStatus() {
  const banner = document.getElementById('offlineBanner');
  if (!navigator.onLine) {
    banner.classList.remove('hidden');
  } else {
    banner.classList.add('hidden');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

/* ================================================================
   DATA & STATE
   ================================================================ */
const ICONS = {
  'respiration':'üå¨Ô∏è','m√©ditation':'üßò','lecture':'üìñ','√©chauffement':'ü§∏',
  'danse':'üíÉ','sport':'üèãÔ∏è','douche':'üöø','√©criture':'‚úçÔ∏è','planification':'üìù',
  'yoga':'üßò‚Äç‚ôÄÔ∏è','marche':'üö∂','course':'üèÉ','musique':'üéµ','journal':'üìì',
  'affirmations':'üíõ','visualisation':'üîÆ','gratitude':'üôè','petit-d√©jeuner':'‚òï',
  'stretching':'ü§∏‚Äç‚ôÄÔ∏è','default':'‚ú®'
};

function gIcon(n) { const l=n.toLowerCase(); for(const[k,v]of Object.entries(ICONS))if(l.includes(k))return v; return ICONS.default; }

const DEF_ROUTINES = [{
  id:'default', name:'Miracle Morning',
  activities:[
    {id:'a1',name:'Respiration',duration:300},{id:'a2',name:'M√©ditation',duration:600},
    {id:'a3',name:'Lecture',duration:600},{id:'a4',name:'√âchauffement',duration:300},
    {id:'a5',name:'Danse / mise en mouvement',duration:300},{id:'a6',name:'Sport',duration:1200},
    {id:'a7',name:'Douche',duration:600},{id:'a8',name:'√âcriture',duration:900},
    {id:'a9',name:'Planification (essentiel du jour)',duration:420}
  ]
}];

let state = { routines:[], activeRoutineId:'default', alarm:{time:'06:00',enabled:false,autoStart:false}, muted:false };
let exec = { running:false, paused:false, loop:false, currentIndex:0, activityStartTime:0, pausedElapsed:0, intervalId:null, alarmIntervalId:null, alarmRinging:false };

/* PERSISTENCE */
const SK='miracleMorning_v3';
function save(){try{localStorage.setItem(SK,JSON.stringify(state));}catch(e){}}
function load(){
  try{
    const r=localStorage.getItem(SK);
    if(r){const s=JSON.parse(r);state.routines=s.routines||clone(DEF_ROUTINES);state.activeRoutineId=s.activeRoutineId||state.routines[0]?.id;state.alarm={...state.alarm,...s.alarm};state.muted=s.muted||false;}
    else state.routines=clone(DEF_ROUTINES);
  }catch(e){state.routines=clone(DEF_ROUTINES);}
  if(!state.routines.length)state.routines=clone(DEF_ROUTINES);
  if(!state.routines.find(r=>r.id===state.activeRoutineId))state.activeRoutineId=state.routines[0].id;
}

/* HELPERS */
function clone(o){return JSON.parse(JSON.stringify(o));}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
function fmt(s){return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}
function fmtL(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return h>0?`${h}h${String(m).padStart(2,'0')}min`:`${m}min ${String(sec).padStart(2,'0')}s`;}
function gR(){return state.routines.find(r=>r.id===state.activeRoutineId);}
function tD(r){return(r?.activities||[]).reduce((s,a)=>s+a.duration,0);}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

/* AUDIO */
let audioCtx=null;
function gAC(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();return audioCtx;}

function playChime(){
  if(state.muted)return;
  try{const c=gAC(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='sine';o.frequency.setValueAtTime(800,c.currentTime);o.frequency.exponentialRampToValueAtTime(1200,c.currentTime+0.15);o.frequency.exponentialRampToValueAtTime(800,c.currentTime+0.3);g.gain.setValueAtTime(0.15,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.5);o.start(c.currentTime);o.stop(c.currentTime+0.5);}catch(e){}
}

let alarmIds=[];
function playAlarm(){
  if(state.muted)return;stopAlarmSnd();
  try{const c=gAC();function ring(){const o1=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();o1.connect(g);o2.connect(g);g.connect(c.destination);o1.type='sine';o1.frequency.value=523.25;o2.type='sine';o2.frequency.value=659.25;g.gain.setValueAtTime(0.12,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+1);o1.start(c.currentTime);o2.start(c.currentTime);o1.stop(c.currentTime+1);o2.stop(c.currentTime+1);}ring();alarmIds.push(setInterval(ring,2000));}catch(e){}
}
function stopAlarmSnd(){alarmIds.forEach(id=>clearInterval(id));alarmIds=[];}
function vibrate(){if(navigator.vibrate)navigator.vibrate([200,100,200]);}

/* ================================================================
   RENDER
   ================================================================ */
function renderConfig(){
  document.getElementById('alarmTime').value=state.alarm.time;
  document.getElementById('alarmEnabled').checked=state.alarm.enabled;
  document.getElementById('alarmAutoStart').checked=state.alarm.autoStart;
  const sel=document.getElementById('routineSelect');
  sel.innerHTML=state.routines.map(r=>`<option value="${r.id}" ${r.id===state.activeRoutineId?'selected':''}>${r.name}</option>`).join('');
  document.getElementById('btnDeleteRoutine').disabled=state.routines.length<=1;
  renderActs();
}

function renderActs(){
  const routine=gR();if(!routine)return;
  const total=tD(routine);
  document.getElementById('routineTotal').innerHTML=`Dur√©e totale : <strong>${fmtL(total)}</strong> ‚Äî ${routine.activities.length} activit√©${routine.activities.length>1?'s':''}`;
  document.getElementById('activityList').innerHTML=routine.activities.map((a,i)=>`
    <div class="activity-item" draggable="true" data-index="${i}" ondragstart="onDS(event)" ondragover="onDO(event)" ondragenter="onDE(event)" ondragleave="onDL(event)" ondrop="onDD(event)" ondragend="onDN(event)">
      <span class="activity-grip">‚†ø</span>
      <span class="activity-icon-col">${gIcon(a.name)}</span>
      <div class="activity-info"><div class="activity-name">${esc(a.name)}</div></div>
      <div class="activity-duration">${fmt(a.duration)}</div>
      <div class="activity-actions">
        <button onclick="editAct('${a.id}')" title="Modifier">‚úèÔ∏è</button>
        <button class="del-btn" onclick="delAct('${a.id}')" title="Supprimer">‚úï</button>
      </div>
    </div>`).join('');
  document.getElementById('btnStart').disabled=!routine.activities.length;
}

/* ALARM */
document.getElementById('alarmTime').addEventListener('change',e=>{state.alarm.time=e.target.value;save();});
document.getElementById('alarmEnabled').addEventListener('change',e=>{state.alarm.enabled=e.target.checked;save();setupAlarm();});
document.getElementById('alarmAutoStart').addEventListener('change',e=>{state.alarm.autoStart=e.target.checked;save();});

function setupAlarm(){
  if(exec.alarmIntervalId)clearInterval(exec.alarmIntervalId);
  if(!state.alarm.enabled)return;
  exec.alarmIntervalId=setInterval(()=>{
    if(!state.alarm.enabled||exec.alarmRinging)return;
    const n=new Date(),[h,m]=state.alarm.time.split(':').map(Number);
    if(n.getHours()===h&&n.getMinutes()===m&&n.getSeconds()<2)triggerAlarm();
  },1000);
}

function triggerAlarm(){
  exec.alarmRinging=true;
  document.getElementById('alarmTimeDisplay').textContent=state.alarm.time;
  document.getElementById('alarmOverlay').classList.remove('hidden');
  playAlarm();vibrate();
}

function stopAlarm(){
  exec.alarmRinging=false;stopAlarmSnd();
  document.getElementById('alarmOverlay').classList.add('hidden');
  if(state.alarm.autoStart)startRoutine();
}

/* ROUTINE CRUD */
document.getElementById('routineSelect').addEventListener('change',e=>{state.activeRoutineId=e.target.value;save();renderConfig();});

function createRoutine(){
  showModal('Nouvelle routine',[{key:'name',label:'Nom',type:'text',value:''}],d=>{
    if(!d.name.trim())return;const r={id:uid(),name:d.name.trim(),activities:[]};
    state.routines.push(r);state.activeRoutineId=r.id;save();renderConfig();
  });
}
function renameRoutine(){
  const r=gR();if(!r)return;
  showModal('Renommer',[{key:'name',label:'Nom',type:'text',value:r.name}],d=>{
    if(!d.name.trim())return;r.name=d.name.trim();save();renderConfig();
  });
}
function duplicateRoutine(){
  const r=gR();if(!r)return;
  const c=clone(r);c.id=uid();c.name=r.name+' (copie)';c.activities.forEach(a=>a.id=uid());
  state.routines.push(c);state.activeRoutineId=c.id;save();renderConfig();
}
function deleteRoutine(){
  if(state.routines.length<=1)return;const r=gR();
  if(!confirm(`Supprimer ¬´ ${r.name} ¬ª ?`))return;
  state.routines=state.routines.filter(x=>x.id!==r.id);state.activeRoutineId=state.routines[0].id;save();renderConfig();
}

/* ACTIVITY CRUD */
function addActivity(){
  const r=gR();if(!r)return;
  const nE=document.getElementById('newActivityName'),mE=document.getElementById('newActivityMin'),sE=document.getElementById('newActivitySec');
  const name=nE.value.trim();if(!name){nE.focus();return;}
  const dur=(parseInt(mE.value)||0)*60+(parseInt(sE.value)||0);if(dur<=0){mE.focus();return;}
  r.activities.push({id:uid(),name,duration:dur});nE.value='';mE.value='5';sE.value='0';save();renderActs();
}
document.getElementById('newActivityName').addEventListener('keydown',e=>{if(e.key==='Enter')addActivity();});

function editAct(id){
  const r=gR(),a=r.activities.find(x=>x.id===id);if(!a)return;
  showModal('Modifier',[
    {key:'name',label:'Nom',type:'text',value:a.name},
    {key:'min',label:'Minutes',type:'number',value:Math.floor(a.duration/60)},
    {key:'sec',label:'Secondes',type:'number',value:a.duration%60}
  ],d=>{
    if(!d.name.trim())return;a.name=d.name.trim();
    const dur=(parseInt(d.min)||0)*60+(parseInt(d.sec)||0);if(dur>0)a.duration=dur;
    save();renderActs();
  });
}
function delAct(id){const r=gR();r.activities=r.activities.filter(a=>a.id!==id);save();renderActs();}

/* DRAG & DROP */
let di=null;
function onDS(e){di=+e.currentTarget.dataset.index;e.currentTarget.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',di);}
function onDO(e){e.preventDefault();e.dataTransfer.dropEffect='move';}
function onDE(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDL(e){e.currentTarget.classList.remove('drag-over');}
function onDD(e){e.preventDefault();e.currentTarget.classList.remove('drag-over');const ti=+e.currentTarget.dataset.index;if(di===null||di===ti)return;const r=gR(),[item]=r.activities.splice(di,1);r.activities.splice(ti,0,item);save();renderActs();}
function onDN(e){e.currentTarget.classList.remove('dragging');di=null;document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));}

/* MODAL */
function showModal(title,fields,onConfirm){
  const bd=document.getElementById('modalBackdrop'),ct=document.getElementById('modalContent');
  let h=`<div class="modal-handle"></div><div class="modal-title">${title}</div>`;
  fields.forEach(f=>{h+=`<div class="modal-field"><label>${f.label}</label><input type="${f.type}" id="modal_${f.key}" value="${f.value}" ${f.type==='number'?'min="0" max="99"':''}></div>`;});
  h+=`<div class="modal-actions"><button class="btn-modal-cancel" onclick="closeModal()">Annuler</button><button class="btn-modal-confirm" id="modalOk">Confirmer</button></div>`;
  ct.innerHTML=h;bd.classList.remove('hidden');
  setTimeout(()=>{const f=ct.querySelector('input');if(f){f.focus();f.select();}},100);
  document.getElementById('modalOk').onclick=()=>{const d={};fields.forEach(f=>d[f.key]=document.getElementById(`modal_${f.key}`).value);closeModal();onConfirm(d);};
  ct.querySelectorAll('input').forEach(i=>i.addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('modalOk').click();}));
}
function closeModal(e){if(e&&e.target!==document.getElementById('modalBackdrop'))return;document.getElementById('modalBackdrop').classList.add('hidden');}

/* ================================================================
   EXECUTION
   ================================================================ */
const CIRC=2*Math.PI*106;

function startRoutine(){
  const r=gR();if(!r||!r.activities.length)return;
  exec.running=true;exec.paused=false;exec.currentIndex=0;exec.pausedElapsed=0;
  try{document.documentElement.requestFullscreen?.();}catch(e){}
  document.getElementById('configView').classList.add('hidden');
  document.getElementById('startArea').classList.add('hidden');
  document.getElementById('execView').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execRoutineName').textContent=r.name;
  updateMute();updateLoop();startAct();
}

function startAct(){exec.activityStartTime=Date.now();exec.pausedElapsed=0;renderExec();startTick();}

function renderExec(){
  const r=gR(),a=r.activities[exec.currentIndex];if(!a)return;
  const m=document.getElementById('execMain');m.classList.add('transitioning');setTimeout(()=>m.classList.remove('transitioning'),600);
  document.getElementById('execIcon').textContent=gIcon(a.name);
  document.getElementById('execStepLabel').textContent=`Activit√© ${exec.currentIndex+1} / ${r.activities.length}`;
  document.getElementById('execActivityName').textContent=a.name;
  const nx=r.activities[exec.currentIndex+1];
  document.getElementById('execNext').innerHTML=nx?`Suivant : <strong>${esc(nx.name)}</strong>`:(exec.loop?'Suivant : ‚Üª Reprise':'Derni√®re activit√©');
  document.getElementById('btnPrev').disabled=exec.currentIndex===0;
}

function startTick(){if(exec.intervalId)clearInterval(exec.intervalId);exec.intervalId=setInterval(tick,250);}

function tick(){
  if(!exec.running||exec.paused)return;
  const r=gR();if(!r)return;const a=r.activities[exec.currentIndex];if(!a)return;
  const el=Math.floor((Date.now()-exec.activityStartTime)/1000)+exec.pausedElapsed;
  const rem=Math.max(0,a.duration-el);
  document.getElementById('execTimeBig').textContent=fmt(rem);
  const p=a.duration>0?(a.duration-rem)/a.duration:1;
  document.getElementById('execCircle').style.strokeDashoffset=CIRC*(1-p);
  const tb=r.activities.slice(0,exec.currentIndex).reduce((s,x)=>s+x.duration,0);
  const ta=tD(r);const gp=ta>0?(tb+(a.duration-rem))/ta:0;
  document.getElementById('execProgressFill').style.width=(gp*100)+'%';
  const tr=r.activities.slice(exec.currentIndex+1).reduce((s,x)=>s+x.duration,0)+rem;
  document.getElementById('execTotalRemaining').textContent=`Temps total restant : ${fmtL(tr)}`;
  if(rem<=0)onActDone();
}

function onActDone(){
  playChime();vibrate();const r=gR();
  if(exec.currentIndex<r.activities.length-1){exec.currentIndex++;startAct();}
  else if(exec.loop){exec.currentIndex=0;startAct();}
  else onDone();
}

function onDone(){
  exec.running=false;if(exec.intervalId)clearInterval(exec.intervalId);
  try{document.exitFullscreen?.();}catch(e){}
  document.getElementById('execView').classList.add('completion-flash');
  setTimeout(()=>document.getElementById('execView').classList.remove('completion-flash'),700);
  document.getElementById('execMain').classList.add('hidden');
  document.getElementById('execControls').classList.add('hidden');
  document.getElementById('execFinished').classList.remove('hidden');
  document.getElementById('execProgressFill').style.width='100%';
}

function stopRoutine(){
  exec.running=false;exec.paused=false;if(exec.intervalId)clearInterval(exec.intervalId);
  try{document.exitFullscreen?.();}catch(e){}
  document.getElementById('execView').classList.add('hidden');
  document.getElementById('configView').classList.remove('hidden');
  document.getElementById('startArea').classList.remove('hidden');
}

function togglePause(){
  if(!exec.running)return;
  if(exec.paused){exec.activityStartTime=Date.now();exec.paused=false;document.getElementById('btnPlayPause').textContent='‚è∏';startTick();}
  else{exec.pausedElapsed+=Math.floor((Date.now()-exec.activityStartTime)/1000);exec.paused=true;if(exec.intervalId)clearInterval(exec.intervalId);document.getElementById('btnPlayPause').textContent='‚ñ∂';}
}

function nextActivity(){
  const r=gR();if(!r)return;
  if(exec.currentIndex<r.activities.length-1){exec.currentIndex++;exec.paused=false;document.getElementById('btnPlayPause').textContent='‚è∏';startAct();}
  else if(exec.loop){exec.currentIndex=0;exec.paused=false;document.getElementById('btnPlayPause').textContent='‚è∏';startAct();}
}
function prevActivity(){if(exec.currentIndex>0){exec.currentIndex--;exec.paused=false;document.getElementById('btnPlayPause').textContent='‚è∏';startAct();}}

function restartRoutine(){
  exec.currentIndex=0;exec.paused=false;document.getElementById('btnPlayPause').textContent='‚è∏';
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  exec.running=true;startAct();
}

function toggleLoop(){exec.loop=!exec.loop;updateLoop();}
function updateLoop(){document.getElementById('btnLoop').classList.toggle('active',exec.loop);}
function toggleMute(){state.muted=!state.muted;save();updateMute();}
function updateMute(){const b=document.getElementById('btnMute');b.textContent=state.muted?'üîá':'üîî';b.classList.toggle('muted',state.muted);}
function toggleFullscreen(){if(document.fullscreenElement)document.exitFullscreen?.();else document.documentElement.requestFullscreen?.();}

/* INIT */
load();renderConfig();setupAlarm();
document.addEventListener('click',()=>{gAC();try{if('wakeLock' in navigator)navigator.wakeLock.request('screen');}catch(e){}},{once:true});
</script>
</body>
</html>
