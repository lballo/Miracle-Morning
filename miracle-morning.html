<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>My Miracle Morning</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ========================================
   CSS VARIABLES & RESET
   ======================================== */
:root {
  --bg: #FAF8F5;
  --bg-card: #FFFFFF;
  --bg-warm: #F5F0EB;
  --bg-accent: #EDE7DF;
  --text: #2C2824;
  --text-soft: #7A716A;
  --text-muted: #B5ADA5;
  --gold: #C4995C;
  --gold-light: #D4B07C;
  --gold-dark: #A67C42;
  --gold-bg: #FAF3EB;
  --accent: #8B7355;
  --danger: #C45C5C;
  --danger-light: #F5EBEB;
  --success: #5C8B6A;
  --success-light: #EBF5EE;
  --border: #E8E2DB;
  --border-light: #F0EBE5;
  --shadow-sm: 0 1px 3px rgba(44,40,36,0.04);
  --shadow-md: 0 4px 16px rgba(44,40,36,0.06);
  --shadow-lg: 0 8px 32px rgba(44,40,36,0.08);
  --shadow-glow: 0 0 40px rgba(196,153,92,0.15);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --radius-xl: 28px;
  --font-display: 'Cormorant Garamond', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; -webkit-text-size-adjust: 100%; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ========================================
   UTILITY CLASSES
   ======================================== */
.hidden { display: none !important; }

button {
  font-family: var(--font-body);
  cursor: pointer;
  border: none;
  background: none;
  font-size: 0.875rem;
  transition: var(--transition);
}

button:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}

input, select {
  font-family: var(--font-body);
  font-size: 0.9375rem;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.625rem 0.875rem;
  background: var(--bg-card);
  color: var(--text);
  transition: var(--transition);
  outline: none;
  width: 100%;
}

input:focus, select:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(196,153,92,0.12);
}

/* ========================================
   LAYOUT
   ======================================== */
.app {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100dvh;
  position: relative;
}

/* ========================================
   HEADER
   ======================================== */
.app-header {
  padding: 1.5rem 1.25rem 1rem;
  text-align: center;
  position: relative;
}

.app-header h1 {
  font-family: var(--font-display);
  font-size: 1.75rem;
  font-weight: 300;
  letter-spacing: 0.02em;
  color: var(--text);
}

.app-header h1 span {
  color: var(--gold);
  font-style: italic;
}

.header-controls {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-warm);
  color: var(--text-soft);
  font-size: 1.125rem;
  border: 1px solid var(--border-light);
}

.icon-btn:hover { background: var(--bg-accent); color: var(--text); }
.icon-btn.active { background: var(--gold-bg); color: var(--gold); border-color: var(--gold-light); }

/* ========================================
   TABS
   ======================================== */
.tab-bar {
  display: flex;
  gap: 0;
  margin: 0 1.25rem;
  background: var(--bg-warm);
  border-radius: var(--radius-md);
  padding: 4px;
  border: 1px solid var(--border-light);
}

.tab-btn {
  flex: 1;
  padding: 0.625rem;
  border-radius: var(--radius-sm);
  font-size: 0.8125rem;
  font-weight: 500;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  color: var(--text-soft);
}

.tab-btn.active {
  background: var(--bg-card);
  color: var(--text);
  box-shadow: var(--shadow-sm);
}

/* ========================================
   VIEW PANELS
   ======================================== */
.view-panel {
  padding: 1rem 1.25rem 6rem;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========================================
   CARDS
   ======================================== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  padding: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow-sm);
}

.card-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-title .icon { font-size: 1.1rem; }

/* ========================================
   ALARM SECTION
   ======================================== */
.alarm-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.alarm-time-input {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 400;
  text-align: center;
  width: 140px;
  padding: 0.5rem;
  letter-spacing: 0.05em;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
}

/* Toggle switch */
.toggle-wrap {
  display: flex;
  align-items: center;
  gap: 0.625rem;
  font-size: 0.875rem;
  color: var(--text-soft);
}

.toggle {
  position: relative;
  width: 48px;
  height: 28px;
  flex-shrink: 0;
}

.toggle input { opacity: 0; width: 0; height: 0; position: absolute; }

.toggle-track {
  position: absolute;
  inset: 0;
  background: var(--bg-accent);
  border-radius: 14px;
  border: 1.5px solid var(--border);
  cursor: pointer;
  transition: var(--transition);
}

.toggle-track::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 20px; height: 20px;
  background: white;
  border-radius: 50%;
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
}

.toggle input:checked + .toggle-track {
  background: var(--gold);
  border-color: var(--gold-dark);
}

.toggle input:checked + .toggle-track::after {
  transform: translateX(20px);
}

.alarm-note {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
  font-style: italic;
  line-height: 1.5;
}

/* ========================================
   ROUTINE SELECTOR
   ======================================== */
.routine-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.routine-select {
  flex: 1;
  min-width: 140px;
  font-size: 0.875rem;
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-sm);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237A716A' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  padding-right: 2rem;
}

.routine-actions {
  display: flex;
  gap: 0.25rem;
}

.routine-actions .icon-btn {
  width: 34px;
  height: 34px;
  font-size: 0.9rem;
}

.routine-total {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
}

.routine-total strong {
  color: var(--gold);
  font-weight: 600;
}

/* ========================================
   ACTIVITY LIST
   ======================================== */
.activity-list {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
}

.activity-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 0.75rem;
  background: var(--bg-warm);
  border-radius: var(--radius-md);
  border: 1px solid transparent;
  transition: var(--transition);
  position: relative;
}

.activity-item:hover { border-color: var(--border); }

.activity-item.dragging {
  opacity: 0.5;
  border-color: var(--gold);
}

.activity-item.drag-over {
  border-color: var(--gold);
  background: var(--gold-bg);
}

.activity-grip {
  cursor: grab;
  color: var(--text-muted);
  font-size: 0.875rem;
  padding: 0.25rem;
  touch-action: none;
  user-select: none;
}

.activity-grip:active { cursor: grabbing; }

.activity-info {
  flex: 1;
  min-width: 0;
}

.activity-name {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.activity-duration {
  font-family: var(--font-display);
  font-size: 0.9375rem;
  color: var(--gold-dark);
  font-weight: 500;
  letter-spacing: 0.02em;
  white-space: nowrap;
}

.activity-actions {
  display: flex;
  gap: 0.125rem;
}

.activity-actions button {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.activity-actions button:hover { background: var(--bg-accent); color: var(--text); }
.activity-actions .del-btn:hover { background: var(--danger-light); color: var(--danger); }

/* Add activity */
.add-activity-form {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
  align-items: flex-end;
}

.add-activity-form .field { flex: 1; }
.add-activity-form .field-sm { width: 80px; flex-shrink: 0; }

.field label {
  display: block;
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
  font-weight: 500;
}

.field input {
  font-size: 0.8125rem;
  padding: 0.5rem 0.625rem;
}

.btn-add {
  height: 38px;
  width: 38px;
  flex-shrink: 0;
  border-radius: 50%;
  background: var(--gold);
  color: white;
  font-size: 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(196,153,92,0.3);
}

.btn-add:hover { background: var(--gold-dark); transform: scale(1.05); }

/* ========================================
   START BUTTON
   ======================================== */
.start-area {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  padding: 1rem 1.25rem;
  padding-bottom: max(1rem, env(safe-area-inset-bottom));
  background: linear-gradient(to top, var(--bg) 60%, transparent);
  z-index: 50;
}

.btn-start {
  width: 100%;
  padding: 1rem;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  box-shadow: 0 4px 20px rgba(196,153,92,0.35);
}

.btn-start:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(196,153,92,0.45); }
.btn-start:active { transform: translateY(0); }

/* ========================================
   EXECUTION VIEW
   ======================================== */
.execution-view {
  position: fixed;
  inset: 0;
  z-index: 100;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.exec-header {
  padding: 1rem 1.25rem 0.75rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.exec-close {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--bg-warm);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; color: var(--text-soft);
}

.exec-close:hover { background: var(--bg-accent); }

.exec-routine-name {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 400;
  color: var(--text-soft);
}

.exec-mute {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--bg-warm);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.125rem; color: var(--text-soft);
}

.exec-mute.muted { color: var(--danger); }

/* Progress bar */
.exec-progress-bar {
  height: 3px;
  background: var(--bg-accent);
  margin: 0 1.25rem;
  border-radius: 2px;
  overflow: hidden;
}

.exec-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  border-radius: 2px;
  transition: width 0.5s linear;
}

/* Main content */
.exec-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
  text-align: center;
  position: relative;
}

.exec-activity-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  animation: pulseIcon 2s ease-in-out infinite;
}

@keyframes pulseIcon {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}

.exec-step-label {
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
  font-weight: 500;
}

.exec-activity-name {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 400;
  color: var(--text);
  margin-bottom: 1.5rem;
  line-height: 1.2;
}

/* Circular progress */
.exec-circle-wrap {
  position: relative;
  width: 220px;
  height: 220px;
  margin-bottom: 1.5rem;
}

.exec-circle-svg {
  transform: rotate(-90deg);
  width: 100%;
  height: 100%;
}

.exec-circle-bg {
  fill: none;
  stroke: var(--bg-accent);
  stroke-width: 4;
}

.exec-circle-fg {
  fill: none;
  stroke: var(--gold);
  stroke-width: 4;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.5s linear;
}

.exec-circle-time {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.exec-time-big {
  font-family: var(--font-display);
  font-size: 3.5rem;
  font-weight: 300;
  letter-spacing: 0.03em;
  color: var(--text);
  line-height: 1;
}

.exec-time-label {
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.exec-next {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
}

.exec-next strong { color: var(--text-soft); font-weight: 500; }

.exec-total-remaining {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Controls */
.exec-controls {
  padding: 0.75rem 1.25rem;
  padding-bottom: max(1rem, env(safe-area-inset-bottom));
  display: flex;
  flex-direction: column;
  gap: 0.625rem;
}

.exec-controls-main {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}

.ctrl-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--bg-warm);
  border: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.125rem;
  color: var(--text-soft);
}

.ctrl-btn:hover { background: var(--bg-accent); color: var(--text); }

.ctrl-btn-primary {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: white;
  font-size: 1.5rem;
  border: none;
  box-shadow: 0 4px 16px rgba(196,153,92,0.35);
}

.ctrl-btn-primary:hover { transform: scale(1.05); }

.exec-controls-secondary {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}

.ctrl-btn-sm {
  padding: 0.375rem 0.875rem;
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-muted);
  background: var(--bg-warm);
  border: 1px solid var(--border-light);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.ctrl-btn-sm:hover { color: var(--text); background: var(--bg-accent); }
.ctrl-btn-sm.active { color: var(--gold); background: var(--gold-bg); border-color: var(--gold-light); }

/* ========================================
   ALARM OVERLAY
   ======================================== */
.alarm-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  background: linear-gradient(135deg, #2C2824 0%, #1a1714 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
  animation: fadeIn 0.5s ease;
}

.alarm-overlay .alarm-icon {
  font-size: 4rem;
  animation: alarmRing 0.5s ease-in-out infinite alternate;
  margin-bottom: 1rem;
}

@keyframes alarmRing {
  from { transform: rotate(-15deg); }
  to { transform: rotate(15deg); }
}

.alarm-overlay .alarm-time-display {
  font-family: var(--font-display);
  font-size: 4rem;
  font-weight: 300;
  letter-spacing: 0.05em;
  margin-bottom: 0.5rem;
  color: var(--gold-light);
}

.alarm-overlay .alarm-label {
  font-size: 0.875rem;
  color: rgba(255,255,255,0.5);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  margin-bottom: 2rem;
}

.btn-stop-alarm {
  padding: 1rem 2.5rem;
  border-radius: 50px;
  background: var(--gold);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  box-shadow: 0 4px 20px rgba(196,153,92,0.5);
  animation: pulseBtn 2s ease-in-out infinite;
}

@keyframes pulseBtn {
  0%, 100% { box-shadow: 0 4px 20px rgba(196,153,92,0.5); }
  50% { box-shadow: 0 4px 40px rgba(196,153,92,0.8); }
}

/* ========================================
   MODAL
   ======================================== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(44,40,36,0.4);
  backdrop-filter: blur(4px);
  z-index: 300;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}

.modal {
  background: var(--bg-card);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  padding: 1.5rem;
  padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
  width: 100%;
  max-width: 480px;
  max-height: 80dvh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-title {
  font-family: var(--font-display);
  font-size: 1.25rem;
  font-weight: 500;
  margin-bottom: 1rem;
}

.modal-field {
  margin-bottom: 1rem;
}

.modal-field label {
  display: block;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: 0.375rem;
  font-weight: 500;
}

.modal-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1.25rem;
}

.modal-actions button {
  flex: 1;
  padding: 0.75rem;
  border-radius: var(--radius-md);
  font-weight: 500;
  font-size: 0.875rem;
}

.btn-modal-cancel {
  background: var(--bg-warm);
  color: var(--text-soft);
  border: 1px solid var(--border);
}

.btn-modal-confirm {
  background: var(--gold);
  color: white;
}

.btn-modal-confirm:hover { background: var(--gold-dark); }

/* ========================================
   FINISHED SCREEN
   ======================================== */
.exec-finished {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2rem;
}

.exec-finished .done-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.exec-finished h2 {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 300;
  margin-bottom: 0.5rem;
}

.exec-finished p {
  color: var(--text-soft);
  font-size: 0.9375rem;
  margin-bottom: 2rem;
}

.btn-back-config {
  padding: 0.875rem 2rem;
  border-radius: var(--radius-lg);
  background: var(--gold);
  color: white;
  font-weight: 600;
  font-size: 0.9375rem;
  letter-spacing: 0.04em;
}

/* ========================================
   SCROLLBAR
   ======================================== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ========================================
   ACTIVITY TRANSITION
   ======================================== */
.exec-main.transitioning .exec-activity-name,
.exec-main.transitioning .exec-activity-icon {
  animation: activityChange 0.6s ease;
}

@keyframes activityChange {
  0% { opacity: 1; transform: translateY(0); }
  40% { opacity: 0; transform: translateY(-20px); }
  60% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

/* completion animation */
.completion-flash {
  animation: flashGold 0.6s ease;
}

@keyframes flashGold {
  0% { background: var(--bg); }
  30% { background: var(--gold-bg); }
  100% { background: var(--bg); }
}
</style>
</head>
<body>

<!-- ========================================
     APP SHELL
     ======================================== -->
<div class="app" id="app">

  <!-- HEADER -->
  <header class="app-header">
    <h1>My <span>Miracle</span> Morning</h1>
  </header>

  <!-- CONFIG VIEW -->
  <div id="configView">

    <!-- ALARM CARD -->
    <div class="view-panel">
      <div class="card">
        <div class="card-title"><span class="icon">‚è∞</span> R√©veil</div>

        <div class="alarm-row">
          <input type="time" id="alarmTime" class="alarm-time-input" value="06:00">
          <div style="flex:1">
            <div class="toggle-wrap">
              <label class="toggle">
                <input type="checkbox" id="alarmEnabled">
                <span class="toggle-track"></span>
              </label>
              <span>Activ√©</span>
            </div>
            <div class="toggle-wrap" style="margin-top:0.5rem">
              <label class="toggle">
                <input type="checkbox" id="alarmAutoStart">
                <span class="toggle-track"></span>
              </label>
              <span>Auto-start routine</span>
            </div>
          </div>
        </div>

        <div class="alarm-note">‚ö† Le r√©veil n√©cessite que cette page reste ouverte dans votre navigateur.</div>
      </div>

      <!-- ROUTINES CARD -->
      <div class="card">
        <div class="card-title"><span class="icon">üìã</span> Routine</div>

        <div class="routine-header">
          <select id="routineSelect" class="routine-select"></select>
          <div class="routine-actions">
            <button class="icon-btn" onclick="renameRoutine()" title="Renommer">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="duplicateRoutine()" title="Dupliquer">üìë</button>
            <button class="icon-btn" onclick="createRoutine()" title="Nouvelle routine">‚ûï</button>
            <button class="icon-btn" onclick="deleteRoutine()" title="Supprimer" id="btnDeleteRoutine">üóëÔ∏è</button>
          </div>
        </div>

        <div class="routine-total" id="routineTotal"></div>

        <!-- Activity list -->
        <div class="activity-list" id="activityList"></div>

        <!-- Add activity form -->
        <div class="add-activity-form">
          <div class="field">
            <label>Activit√©</label>
            <input type="text" id="newActivityName" placeholder="Nom‚Ä¶">
          </div>
          <div class="field field-sm">
            <label>Min</label>
            <input type="number" id="newActivityMin" min="0" max="99" value="5" style="text-align:center">
          </div>
          <div class="field field-sm">
            <label>Sec</label>
            <input type="number" id="newActivitySec" min="0" max="59" value="0" style="text-align:center">
          </div>
          <button class="btn-add" onclick="addActivity()" title="Ajouter">+</button>
        </div>
      </div>
    </div><!-- /view-panel -->
  </div><!-- /configView -->

  <!-- START AREA -->
  <div class="start-area" id="startArea">
    <button class="btn-start" id="btnStart" onclick="startRoutine()">D√©marrer la routine</button>
  </div>
</div><!-- /app -->

<!-- ========================================
     EXECUTION VIEW (hidden by default)
     ======================================== -->
<div class="execution-view hidden" id="execView">
  <div class="exec-header">
    <button class="exec-close" onclick="stopRoutine()" title="Fermer">‚úï</button>
    <span class="exec-routine-name" id="execRoutineName"></span>
    <button class="exec-mute" id="btnMute" onclick="toggleMute()" title="Son">üîî</button>
  </div>

  <div class="exec-progress-bar">
    <div class="exec-progress-fill" id="execProgressFill"></div>
  </div>

  <!-- Running state -->
  <div class="exec-main" id="execMain">
    <div class="exec-activity-icon" id="execIcon"></div>
    <div class="exec-step-label" id="execStepLabel"></div>
    <div class="exec-activity-name" id="execActivityName"></div>

    <div class="exec-circle-wrap">
      <svg class="exec-circle-svg" viewBox="0 0 220 220">
        <circle class="exec-circle-bg" cx="110" cy="110" r="100"></circle>
        <circle class="exec-circle-fg" id="execCircle" cx="110" cy="110" r="100"
                stroke-dasharray="628.318" stroke-dashoffset="0"></circle>
      </svg>
      <div class="exec-circle-time">
        <div class="exec-time-big" id="execTimeBig">00:00</div>
        <div class="exec-time-label">restant</div>
      </div>
    </div>

    <div class="exec-next" id="execNext"></div>
    <div class="exec-total-remaining" id="execTotalRemaining"></div>
  </div>

  <!-- Finished state -->
  <div class="exec-finished hidden" id="execFinished">
    <div class="done-icon">‚òÄÔ∏è</div>
    <h2>Routine termin√©e !</h2>
    <p>Bravo, ta matin√©e est lanc√©e.</p>
    <button class="btn-back-config" onclick="stopRoutine()">Retour</button>
  </div>

  <!-- Controls -->
  <div class="exec-controls" id="execControls">
    <div class="exec-controls-main">
      <button class="ctrl-btn" id="btnPrev" onclick="prevActivity()" title="Pr√©c√©dent">‚èÆ</button>
      <button class="ctrl-btn-primary ctrl-btn" id="btnPlayPause" onclick="togglePause()">‚è∏</button>
      <button class="ctrl-btn" id="btnNext" onclick="nextActivity()" title="Suivant">‚è≠</button>
    </div>
    <div class="exec-controls-secondary">
      <button class="ctrl-btn-sm" id="btnRestart" onclick="restartRoutine()">‚Üª Recommencer</button>
      <button class="ctrl-btn-sm" id="btnLoop" onclick="toggleLoop()">üîÅ Boucle</button>
      <button class="ctrl-btn-sm" id="btnFullscreen" onclick="toggleFullscreen()">‚õ∂ Plein √©cran</button>
    </div>
  </div>
</div>

<!-- ========================================
     ALARM OVERLAY (hidden by default)
     ======================================== -->
<div class="alarm-overlay hidden" id="alarmOverlay">
  <div class="alarm-icon">üîî</div>
  <div class="alarm-time-display" id="alarmTimeDisplay">06:00</div>
  <div class="alarm-label">Miracle Morning</div>
  <button class="btn-stop-alarm" onclick="stopAlarm()">Arr√™ter le r√©veil</button>
</div>

<!-- ========================================
     MODAL (hidden by default)
     ======================================== -->
<div class="modal-backdrop hidden" id="modalBackdrop" onclick="closeModal(event)">
  <div class="modal" id="modalContent"></div>
</div>


<script>
/* ================================================================
   DATA & STATE
   ================================================================ */

// Activity icons mapping
const ACTIVITY_ICONS = {
  'respiration': 'üå¨Ô∏è', 'm√©ditation': 'üßò', 'lecture': 'üìñ',
  '√©chauffement': 'ü§∏', 'danse': 'üíÉ', 'sport': 'üèãÔ∏è',
  'douche': 'üöø', '√©criture': '‚úçÔ∏è', 'planification': 'üìù',
  'yoga': 'üßò‚Äç‚ôÄÔ∏è', 'marche': 'üö∂', 'course': 'üèÉ',
  'musique': 'üéµ', 'journal': 'üìì', 'affirmations': 'üíõ',
  'visualisation': 'üîÆ', 'gratitude': 'üôè', 'petit-d√©jeuner': '‚òï',
  'stretching': 'ü§∏‚Äç‚ôÄÔ∏è', 'default': '‚ú®'
};

function getActivityIcon(name) {
  const lower = name.toLowerCase();
  for (const [key, icon] of Object.entries(ACTIVITY_ICONS)) {
    if (lower.includes(key)) return icon;
  }
  return ACTIVITY_ICONS.default;
}

// Default routine
const DEFAULT_ROUTINES = [{
  id: 'default',
  name: 'Miracle Morning',
  activities: [
    { id: 'a1', name: 'Respiration', duration: 300 },
    { id: 'a2', name: 'M√©ditation', duration: 600 },
    { id: 'a3', name: 'Lecture', duration: 600 },
    { id: 'a4', name: '√âchauffement', duration: 300 },
    { id: 'a5', name: 'Danse / mise en mouvement', duration: 300 },
    { id: 'a6', name: 'Sport', duration: 1200 },
    { id: 'a7', name: 'Douche', duration: 600 },
    { id: 'a8', name: '√âcriture', duration: 900 },
    { id: 'a9', name: 'Planification (essentiel du jour)', duration: 420 },
  ]
}];

let state = {
  routines: [],
  activeRoutineId: 'default',
  alarm: { time: '06:00', enabled: false, autoStart: false },
  muted: false
};

// Execution state (not persisted)
let exec = {
  running: false,
  paused: false,
  loop: false,
  currentIndex: 0,
  activityStartTime: 0,
  pausedElapsed: 0,
  intervalId: null,
  alarmIntervalId: null,
  alarmRinging: false
};

/* ================================================================
   PERSISTENCE
   ================================================================ */
const STORAGE_KEY = 'miracleMorning_v2';

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const saved = JSON.parse(raw);
      state.routines = saved.routines || DEFAULT_ROUTINES;
      state.activeRoutineId = saved.activeRoutineId || state.routines[0]?.id || 'default';
      state.alarm = { ...state.alarm, ...saved.alarm };
      state.muted = saved.muted || false;
    } else {
      state.routines = JSON.parse(JSON.stringify(DEFAULT_ROUTINES));
    }
  } catch (e) {
    state.routines = JSON.parse(JSON.stringify(DEFAULT_ROUTINES));
  }
  // Ensure at least one routine
  if (!state.routines.length) {
    state.routines = JSON.parse(JSON.stringify(DEFAULT_ROUTINES));
  }
  // Ensure active routine exists
  if (!state.routines.find(r => r.id === state.activeRoutineId)) {
    state.activeRoutineId = state.routines[0].id;
  }
}

/* ================================================================
   HELPERS
   ================================================================ */
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

function formatDuration(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function formatDurationLong(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  if (h > 0) return `${h}h${String(m).padStart(2,'0')}m${String(s).padStart(2,'0')}s`;
  return `${m}min ${String(s).padStart(2,'0')}s`;
}

function getActiveRoutine() {
  return state.routines.find(r => r.id === state.activeRoutineId);
}

function getTotalDuration(routine) {
  return (routine?.activities || []).reduce((sum, a) => sum + a.duration, 0);
}

/* ================================================================
   AUDIO ‚Äî synthesized sounds
   ================================================================ */
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playChime() {
  if (state.muted) return;
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.15);
    osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

// Alarm sound ‚Äî progressive gentle bell
let alarmOscillators = [];

function playAlarmSound() {
  if (state.muted) return;
  stopAlarmSound();
  try {
    const ctx = getAudioCtx();
    function ring() {
      const osc1 = ctx.createOscillator();
      const osc2 = ctx.createOscillator();
      const gain = ctx.createGain();
      osc1.connect(gain);
      osc2.connect(gain);
      gain.connect(ctx.destination);
      osc1.type = 'sine';
      osc1.frequency.value = 523.25; // C5
      osc2.type = 'sine';
      osc2.frequency.value = 659.25; // E5
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
      osc1.start(ctx.currentTime);
      osc2.start(ctx.currentTime);
      osc1.stop(ctx.currentTime + 1);
      osc2.stop(ctx.currentTime + 1);
    }
    ring();
    const id = setInterval(ring, 2000);
    alarmOscillators.push(id);
  } catch(e) {}
}

function stopAlarmSound() {
  alarmOscillators.forEach(id => clearInterval(id));
  alarmOscillators = [];
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

/* ================================================================
   RENDER ‚Äî CONFIG VIEW
   ================================================================ */
function renderConfig() {
  // Alarm
  document.getElementById('alarmTime').value = state.alarm.time;
  document.getElementById('alarmEnabled').checked = state.alarm.enabled;
  document.getElementById('alarmAutoStart').checked = state.alarm.autoStart;

  // Routine selector
  const sel = document.getElementById('routineSelect');
  sel.innerHTML = state.routines.map(r =>
    `<option value="${r.id}" ${r.id === state.activeRoutineId ? 'selected' : ''}>${r.name}</option>`
  ).join('');

  // Delete button state
  document.getElementById('btnDeleteRoutine').disabled = state.routines.length <= 1;

  renderActivities();
}

function renderActivities() {
  const routine = getActiveRoutine();
  if (!routine) return;

  // Total
  const total = getTotalDuration(routine);
  document.getElementById('routineTotal').innerHTML =
    `Dur√©e totale : <strong>${formatDurationLong(total)}</strong> ‚Äî ${routine.activities.length} activit√©${routine.activities.length > 1 ? 's' : ''}`;

  // List
  const list = document.getElementById('activityList');
  list.innerHTML = routine.activities.map((a, i) => `
    <div class="activity-item" draggable="true" data-index="${i}"
         ondragstart="onDragStart(event)" ondragover="onDragOver(event)"
         ondragenter="onDragEnter(event)" ondragleave="onDragLeave(event)"
         ondrop="onDrop(event)" ondragend="onDragEnd(event)">
      <span class="activity-grip">‚†ø</span>
      <span style="font-size:1.1rem">${getActivityIcon(a.name)}</span>
      <div class="activity-info">
        <div class="activity-name">${escHtml(a.name)}</div>
      </div>
      <div class="activity-duration">${formatDuration(a.duration)}</div>
      <div class="activity-actions">
        <button onclick="editActivity('${a.id}')" title="Modifier">‚úèÔ∏è</button>
        <button class="del-btn" onclick="deleteActivity('${a.id}')" title="Supprimer">‚úï</button>
      </div>
    </div>
  `).join('');

  // Start button state
  document.getElementById('btnStart').disabled = !routine.activities.length;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

/* ================================================================
   ALARM EVENTS
   ================================================================ */
document.getElementById('alarmTime').addEventListener('change', e => {
  state.alarm.time = e.target.value;
  save();
});

document.getElementById('alarmEnabled').addEventListener('change', e => {
  state.alarm.enabled = e.target.checked;
  save();
  setupAlarmCheck();
});

document.getElementById('alarmAutoStart').addEventListener('change', e => {
  state.alarm.autoStart = e.target.checked;
  save();
});

/* ================================================================
   ALARM LOGIC
   ================================================================ */
function setupAlarmCheck() {
  if (exec.alarmIntervalId) clearInterval(exec.alarmIntervalId);
  if (!state.alarm.enabled) return;

  exec.alarmIntervalId = setInterval(() => {
    if (!state.alarm.enabled || exec.alarmRinging) return;
    const now = new Date();
    const [h, m] = state.alarm.time.split(':').map(Number);
    if (now.getHours() === h && now.getMinutes() === m && now.getSeconds() < 2) {
      triggerAlarm();
    }
  }, 1000);
}

function triggerAlarm() {
  exec.alarmRinging = true;
  document.getElementById('alarmTimeDisplay').textContent = state.alarm.time;
  document.getElementById('alarmOverlay').classList.remove('hidden');
  playAlarmSound();
  vibrate();
}

function stopAlarm() {
  exec.alarmRinging = false;
  stopAlarmSound();
  document.getElementById('alarmOverlay').classList.add('hidden');

  if (state.alarm.autoStart) {
    startRoutine();
  }
}

/* ================================================================
   ROUTINE SELECTOR
   ================================================================ */
document.getElementById('routineSelect').addEventListener('change', e => {
  state.activeRoutineId = e.target.value;
  save();
  renderConfig();
});

/* ================================================================
   ROUTINE CRUD
   ================================================================ */
function createRoutine() {
  showModal('Nouvelle routine', [
    { key: 'name', label: 'Nom', type: 'text', value: '' }
  ], (data) => {
    if (!data.name.trim()) return;
    const r = { id: uid(), name: data.name.trim(), activities: [] };
    state.routines.push(r);
    state.activeRoutineId = r.id;
    save();
    renderConfig();
  });
}

function renameRoutine() {
  const routine = getActiveRoutine();
  if (!routine) return;
  showModal('Renommer la routine', [
    { key: 'name', label: 'Nom', type: 'text', value: routine.name }
  ], (data) => {
    if (!data.name.trim()) return;
    routine.name = data.name.trim();
    save();
    renderConfig();
  });
}

function duplicateRoutine() {
  const routine = getActiveRoutine();
  if (!routine) return;
  const copy = JSON.parse(JSON.stringify(routine));
  copy.id = uid();
  copy.name = routine.name + ' (copie)';
  copy.activities.forEach(a => a.id = uid());
  state.routines.push(copy);
  state.activeRoutineId = copy.id;
  save();
  renderConfig();
}

function deleteRoutine() {
  if (state.routines.length <= 1) return;
  const routine = getActiveRoutine();
  if (!confirm(`Supprimer la routine ¬´ ${routine.name} ¬ª ?`)) return;
  state.routines = state.routines.filter(r => r.id !== routine.id);
  state.activeRoutineId = state.routines[0].id;
  save();
  renderConfig();
}

/* ================================================================
   ACTIVITY CRUD
   ================================================================ */
function addActivity() {
  const routine = getActiveRoutine();
  if (!routine) return;
  const nameEl = document.getElementById('newActivityName');
  const minEl = document.getElementById('newActivityMin');
  const secEl = document.getElementById('newActivitySec');
  const name = nameEl.value.trim();
  if (!name) { nameEl.focus(); return; }
  const mins = parseInt(minEl.value) || 0;
  const secs = parseInt(secEl.value) || 0;
  const duration = mins * 60 + secs;
  if (duration <= 0) { minEl.focus(); return; }

  routine.activities.push({ id: uid(), name, duration });
  nameEl.value = '';
  minEl.value = '5';
  secEl.value = '0';
  save();
  renderActivities();
}

// Enter key to add
document.getElementById('newActivityName').addEventListener('keydown', e => {
  if (e.key === 'Enter') addActivity();
});

function editActivity(actId) {
  const routine = getActiveRoutine();
  const act = routine.activities.find(a => a.id === actId);
  if (!act) return;
  const mins = Math.floor(act.duration / 60);
  const secs = act.duration % 60;

  showModal('Modifier l\'activit√©', [
    { key: 'name', label: 'Nom', type: 'text', value: act.name },
    { key: 'min', label: 'Minutes', type: 'number', value: mins },
    { key: 'sec', label: 'Secondes', type: 'number', value: secs }
  ], (data) => {
    if (!data.name.trim()) return;
    act.name = data.name.trim();
    const d = (parseInt(data.min) || 0) * 60 + (parseInt(data.sec) || 0);
    if (d > 0) act.duration = d;
    save();
    renderActivities();
  });
}

function deleteActivity(actId) {
  const routine = getActiveRoutine();
  routine.activities = routine.activities.filter(a => a.id !== actId);
  save();
  renderActivities();
}

/* ================================================================
   DRAG & DROP REORDER
   ================================================================ */
let dragIndex = null;

function onDragStart(e) {
  dragIndex = parseInt(e.currentTarget.dataset.index);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', dragIndex);
}

function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

function onDragEnter(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

function onDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const toIndex = parseInt(e.currentTarget.dataset.index);
  if (dragIndex === null || dragIndex === toIndex) return;
  const routine = getActiveRoutine();
  const [item] = routine.activities.splice(dragIndex, 1);
  routine.activities.splice(toIndex, 0, item);
  save();
  renderActivities();
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  dragIndex = null;
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

/* ================================================================
   MODAL SYSTEM
   ================================================================ */
function showModal(title, fields, onConfirm) {
  const backdrop = document.getElementById('modalBackdrop');
  const content = document.getElementById('modalContent');

  let html = `<div class="modal-title">${title}</div>`;
  fields.forEach(f => {
    html += `<div class="modal-field">
      <label>${f.label}</label>
      <input type="${f.type}" id="modal_${f.key}" value="${f.value}" ${f.type === 'number' ? 'min="0" max="99"' : ''}>
    </div>`;
  });
  html += `<div class="modal-actions">
    <button class="btn-modal-cancel" onclick="closeModal()">Annuler</button>
    <button class="btn-modal-confirm" id="modalConfirmBtn">Confirmer</button>
  </div>`;

  content.innerHTML = html;
  backdrop.classList.remove('hidden');

  // Focus first field
  setTimeout(() => {
    const first = content.querySelector('input');
    if (first) { first.focus(); first.select(); }
  }, 100);

  // Confirm handler
  document.getElementById('modalConfirmBtn').onclick = () => {
    const data = {};
    fields.forEach(f => {
      data[f.key] = document.getElementById(`modal_${f.key}`).value;
    });
    closeModal();
    onConfirm(data);
  };

  // Enter key
  content.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('modalConfirmBtn').click();
    });
  });
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalBackdrop')) return;
  document.getElementById('modalBackdrop').classList.add('hidden');
}

/* ================================================================
   EXECUTION ENGINE
   ================================================================ */
function startRoutine() {
  const routine = getActiveRoutine();
  if (!routine || !routine.activities.length) return;

  exec.running = true;
  exec.paused = false;
  exec.currentIndex = 0;
  exec.pausedElapsed = 0;

  // Try to enter fullscreen
  try { document.documentElement.requestFullscreen?.(); } catch(e) {}

  document.getElementById('configView').classList.add('hidden');
  document.getElementById('startArea').classList.add('hidden');
  document.getElementById('execView').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execRoutineName').textContent = routine.name;

  updateMuteBtn();
  updateLoopBtn();
  startActivity();
}

function startActivity() {
  const routine = getActiveRoutine();
  if (!routine) return;

  exec.activityStartTime = Date.now();
  exec.pausedElapsed = 0;
  renderExecActivity();
  startTick();
}

function renderExecActivity() {
  const routine = getActiveRoutine();
  const act = routine.activities[exec.currentIndex];
  if (!act) return;

  const main = document.getElementById('execMain');
  main.classList.add('transitioning');
  setTimeout(() => main.classList.remove('transitioning'), 600);

  document.getElementById('execIcon').textContent = getActivityIcon(act.name);
  document.getElementById('execStepLabel').textContent =
    `Activit√© ${exec.currentIndex + 1} / ${routine.activities.length}`;
  document.getElementById('execActivityName').textContent = act.name;

  // Next
  const next = routine.activities[exec.currentIndex + 1];
  document.getElementById('execNext').innerHTML = next
    ? `Suivant : <strong>${escHtml(next.name)}</strong>`
    : (exec.loop ? 'Suivant : ‚Üª Reprise du d√©but' : 'Derni√®re activit√©');

  // Update prev/next buttons
  document.getElementById('btnPrev').disabled = exec.currentIndex === 0;
}

function startTick() {
  if (exec.intervalId) clearInterval(exec.intervalId);
  exec.intervalId = setInterval(tick, 250);
}

function tick() {
  if (!exec.running || exec.paused) return;

  const routine = getActiveRoutine();
  if (!routine) return;
  const act = routine.activities[exec.currentIndex];
  if (!act) return;

  // Calculate elapsed using Date.now for accuracy even when tab is inactive
  const elapsed = Math.floor((Date.now() - exec.activityStartTime) / 1000) + exec.pausedElapsed;
  const remaining = Math.max(0, act.duration - elapsed);

  // Update display
  document.getElementById('execTimeBig').textContent = formatDuration(remaining);

  // Circular progress
  const progress = act.duration > 0 ? (act.duration - remaining) / act.duration : 1;
  const circumference = 2 * Math.PI * 100;
  document.getElementById('execCircle').style.strokeDashoffset =
    circumference * (1 - progress);

  // Global progress
  const totalBefore = routine.activities.slice(0, exec.currentIndex).reduce((s, a) => s + a.duration, 0);
  const totalAll = getTotalDuration(routine);
  const globalProgress = totalAll > 0 ? (totalBefore + (act.duration - remaining)) / totalAll : 0;
  document.getElementById('execProgressFill').style.width = (globalProgress * 100) + '%';

  // Total remaining
  const totalRemaining = routine.activities.slice(exec.currentIndex + 1).reduce((s, a) => s + a.duration, 0) + remaining;
  document.getElementById('execTotalRemaining').textContent =
    `Temps total restant : ${formatDurationLong(totalRemaining)}`;

  // Check if activity is done
  if (remaining <= 0) {
    onActivityComplete();
  }
}

function onActivityComplete() {
  playChime();
  vibrate();

  const routine = getActiveRoutine();
  if (exec.currentIndex < routine.activities.length - 1) {
    exec.currentIndex++;
    startActivity();
  } else if (exec.loop) {
    exec.currentIndex = 0;
    startActivity();
  } else {
    onRoutineComplete();
  }
}

function onRoutineComplete() {
  exec.running = false;
  if (exec.intervalId) clearInterval(exec.intervalId);

  // Exit fullscreen
  try { document.exitFullscreen?.(); } catch(e) {}

  const ev = document.getElementById('execView');
  ev.classList.add('completion-flash');
  setTimeout(() => ev.classList.remove('completion-flash'), 600);

  document.getElementById('execMain').classList.add('hidden');
  document.getElementById('execControls').classList.add('hidden');
  document.getElementById('execFinished').classList.remove('hidden');

  // Set progress to 100%
  document.getElementById('execProgressFill').style.width = '100%';
}

function stopRoutine() {
  exec.running = false;
  exec.paused = false;
  if (exec.intervalId) clearInterval(exec.intervalId);

  try { document.exitFullscreen?.(); } catch(e) {}

  document.getElementById('execView').classList.add('hidden');
  document.getElementById('configView').classList.remove('hidden');
  document.getElementById('startArea').classList.remove('hidden');
}

function togglePause() {
  if (!exec.running) return;

  if (exec.paused) {
    // Resume: adjust start time
    exec.activityStartTime = Date.now();
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startTick();
  } else {
    // Pause: save elapsed
    const elapsed = Math.floor((Date.now() - exec.activityStartTime) / 1000);
    exec.pausedElapsed += elapsed;
    exec.paused = true;
    if (exec.intervalId) clearInterval(exec.intervalId);
    document.getElementById('btnPlayPause').textContent = '‚ñ∂';
  }
}

function nextActivity() {
  const routine = getActiveRoutine();
  if (!routine) return;
  if (exec.currentIndex < routine.activities.length - 1) {
    exec.currentIndex++;
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startActivity();
  } else if (exec.loop) {
    exec.currentIndex = 0;
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startActivity();
  }
}

function prevActivity() {
  if (exec.currentIndex > 0) {
    exec.currentIndex--;
    exec.paused = false;
    document.getElementById('btnPlayPause').textContent = '‚è∏';
    startActivity();
  }
}

function restartRoutine() {
  exec.currentIndex = 0;
  exec.paused = false;
  document.getElementById('btnPlayPause').textContent = '‚è∏';
  document.getElementById('execMain').classList.remove('hidden');
  document.getElementById('execControls').classList.remove('hidden');
  document.getElementById('execFinished').classList.add('hidden');
  exec.running = true;
  startActivity();
}

function toggleLoop() {
  exec.loop = !exec.loop;
  updateLoopBtn();
}

function updateLoopBtn() {
  document.getElementById('btnLoop').classList.toggle('active', exec.loop);
}

function toggleMute() {
  state.muted = !state.muted;
  save();
  updateMuteBtn();
}

function updateMuteBtn() {
  const btn = document.getElementById('btnMute');
  btn.textContent = state.muted ? 'üîá' : 'üîî';
  btn.classList.toggle('muted', state.muted);
}

function toggleFullscreen() {
  if (document.fullscreenElement) {
    document.exitFullscreen?.();
  } else {
    document.documentElement.requestFullscreen?.();
  }
}

/* ================================================================
   INIT
   ================================================================ */
load();
renderConfig();
setupAlarmCheck();

// Wake lock to keep screen alive during execution
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      await navigator.wakeLock.request('screen');
    }
  } catch(e) {}
}

// Initialize audio context on first interaction (required by browsers)
document.addEventListener('click', () => {
  getAudioCtx();
  requestWakeLock();
}, { once: true });
</script>
</body>
</html>
